<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RealiSimHQ AC Physics Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root {
    --bg: #08080f; --bg2: #0e0e1a; --bg3: #151525;
    --border: #1a1a35; --border-hi: #00e5ff;
    --cyan: #00e5ff; --cyan-dim: #00e5ff44; --cyan-glow: #00e5ff22;
    --green: #00ff88; --red: #ff4466; --orange: #ffaa00;
    --text: #e0e0e8; --text2: #8888aa; --text3: #555577;
    --radius: 10px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Inter','Segoe UI',system-ui,sans-serif; line-height: 1.5; }
.app { max-width: 1100px; margin: 0 auto; padding: 20px; }
header { text-align: center; padding: 30px 0 20px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
header h1 { font-size: 2.2em; letter-spacing: -1px; }
header h1 span { color: var(--cyan); }
header p { color: var(--text2); margin-top: 4px; }

.step { display: none; animation: fadeIn .3s ease; }
.step.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:none; } }

.progress { display: flex; gap: 6px; margin-bottom: 30px; }
.progress-dot { height: 4px; flex: 1; background: var(--border); border-radius: 2px; transition: background .3s; }
.progress-dot.done { background: var(--cyan); }
.progress-dot.current { background: linear-gradient(90deg, var(--cyan), var(--cyan-dim)); }

.drop-zone {
    border: 2px dashed var(--border); border-radius: 16px; padding: 60px 40px;
    text-align: center; cursor: pointer; transition: all .3s ease;
    background: linear-gradient(135deg, var(--bg2), var(--bg3));
    position: relative; overflow: hidden;
}
.drop-zone::before {
    content: ''; position: absolute; inset: 0; border-radius: 16px;
    background: radial-gradient(circle at 50% 50%, var(--cyan-glow) 0%, transparent 70%);
    opacity: 0; transition: opacity .3s;
}
.drop-zone:hover, .drop-zone.dragover { border-color: var(--cyan); box-shadow: 0 0 40px var(--cyan-glow); }
.drop-zone:hover::before, .drop-zone.dragover::before { opacity: 1; }
.drop-zone .icon { font-size: 3em; margin-bottom: 12px; filter: drop-shadow(0 0 20px var(--cyan)); }
.drop-zone .title { font-size: 1.3em; font-weight: 700; color: var(--cyan); position: relative; }
.drop-zone .subtitle { color: var(--text2); margin-top: 8px; font-size: .9em; position: relative; }
.drop-zone .formats { color: var(--text3); margin-top: 16px; font-size: .8em; position: relative;
    display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
.drop-zone .formats span { background: var(--bg); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border); }
.drop-zone input { display: none; }
.drop-zone.loading .icon { animation: pulse 1.5s ease infinite; }
@keyframes pulse { 0%,100% { opacity:.5; } 50% { opacity:1; } }

.car-banner {
    background: var(--bg2); border: 1px solid var(--cyan-dim); border-radius: var(--radius);
    padding: 16px 20px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
}
.car-banner .name { font-size: 1.3em; font-weight: 700; }
.car-banner .detail { color: var(--text2); font-size: .85em; margin-top: 2px; }
.car-banner .stats { display: flex; gap: 8px; flex-wrap: wrap; }
.car-banner .stat { background: var(--bg3); padding: 4px 10px; border-radius: 6px; font-size: .8em; color: var(--text2); }

.mode-select { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
@media (max-width:600px) { .mode-select { grid-template-columns: 1fr; } }
.mode-card {
    background: var(--bg2); border: 2px solid var(--border); border-radius: var(--radius);
    padding: 24px; cursor: pointer; transition: all .2s; text-align: center;
}
.mode-card:hover { border-color: var(--cyan); transform: translateY(-2px); }
.mode-card.selected { border-color: var(--cyan); background: #00e5ff08; }
.mode-card .mode-icon { font-size: 2em; margin-bottom: 8px; }
.mode-card .mode-title { font-size: 1.1em; font-weight: 700; color: var(--cyan); }
.mode-card .mode-desc { color: var(--text2); font-size: .85em; margin-top: 4px; }

.class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
.class-card {
    background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px; cursor: pointer; transition: all .15s; text-align: center;
}
.class-card:hover { border-color: var(--cyan-dim); }
.class-card.selected { border-color: var(--cyan); background: #00e5ff08; }
.class-card .class-name { font-weight: 700; color: var(--cyan); }
.class-card .class-hp { color: var(--orange); font-size: .85em; margin-top: 2px; }
.class-card .class-desc { color: var(--text3); font-size: .8em; margin-top: 4px; }

.parts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width:768px) { .parts-grid { grid-template-columns: 1fr; } }
.part-group { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
.part-group h3 { font-size: 1em; color: var(--cyan); margin-bottom: 10px; }
.part-option { padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: all .15s; font-size: .9em; }
.part-option:hover { border-color: var(--cyan-dim); }
.part-option.selected { border-color: var(--cyan); background: #00e5ff08; }
.part-option.disabled { opacity: 0.35; pointer-events: none; }
.part-option .part-name { font-weight: 600; }
.part-option .part-desc { color: var(--text3); font-size: .8em; margin-top: 2px; }
.part-option .part-spec { color: var(--orange); font-size: .8em; margin-top: 2px; }

.summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 10px; margin-bottom: 24px; }
.summary-card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; }
.summary-card .label { color: var(--text2); font-size: .8em; text-transform: uppercase; letter-spacing: 1px; }
.summary-card .value { color: var(--cyan); font-size: 1.6em; font-weight: 700; margin-top: 2px; }
.summary-card .unit { color: var(--text3); font-size: .7em; }

details.comp-details { margin-bottom: 20px; }
details.comp-details summary { cursor: pointer; color: var(--cyan); font-weight: 600; padding: 8px 0; }
.comp-section { margin-bottom: 16px; }
.comp-section h3 { color: var(--text2); font-size: .85em; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
table { width: 100%; border-collapse: collapse; }
th { background: var(--bg3); color: var(--text2); padding: 8px 12px; text-align: left; font-size: .8em; text-transform: uppercase; letter-spacing: 1px; }
td { padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: .9em; }
td.stock { color: var(--text2); }
td.changed { color: var(--orange); font-weight: 600; }

.btn { background: var(--cyan); color: var(--bg); border: none; border-radius: var(--radius);
    padding: 14px 32px; font-size: 1.05em; font-weight: 700; cursor: pointer; transition: all .2s;
    display: inline-flex; align-items: center; gap: 8px; }
.btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text);
    border-radius: var(--radius); padding: 10px 20px; font-size: .9em; cursor: pointer; transition: all .2s; }
.btn-outline:hover { border-color: var(--cyan); color: var(--cyan); }
.btn-row { display: flex; gap: 10px; margin-top: 24px; justify-content: center; flex-wrap: wrap; }

footer { text-align: center; color: var(--text3); font-size: .8em; padding: 40px 0 20px; border-top: 1px solid var(--border); margin-top: 40px; }
</style>
</head>
<body>
<div class="app">
    <header>
        <h1>‚ö° <span>RealiSimHQ</span> Physics Tool</h1>
        <p>Drop your car ‚Üí Pick your parts ‚Üí Download real physics</p>
    </header>
    <div class="progress" id="progress">
        <div class="progress-dot current" data-step="1"></div>
        <div class="progress-dot" data-step="2"></div>
        <div class="progress-dot" data-step="3"></div>
    </div>

    <!-- STEP 1: Upload -->
    <div class="step active" id="step1">
        <div class="drop-zone" id="dropZone">
            <div class="icon">üìÅ</div>
            <div class="title">Drop your car's data folder here</div>
            <div class="subtitle">Drag & drop a folder or individual .ini files</div>
            <div class="formats">
                <span>car.ini</span><span>suspensions.ini</span><span>tyres.ini</span>
                <span>drivetrain.ini</span><span>brakes.ini</span>
            </div>
            <input type="file" id="fileInput" multiple>
            <input type="file" id="folderInput" webkitdirectory multiple>
        </div>
        <p style="text-align:center;color:var(--text3);margin-top:12px;font-size:.85em;">
            Find your car's data in: <code style="color:var(--cyan);">assettocorsa/content/cars/YOUR_CAR/data/</code>
            <br>Click to browse files, or <strong>Shift+Click</strong> for folder select
        </p>
    </div>

    <!-- STEP 2: Build Mode -->
    <div class="step" id="step2">
        <div class="car-banner" id="carBanner"></div>
        <div class="mode-select" id="modeSelect">
            <div class="mode-card" onclick="selectMode('quick')">
                <div class="mode-icon">üöÄ</div>
                <div class="mode-title">Quick Build</div>
                <div class="mode-desc">Pick a class preset ‚Äî Factory, Grassroots, Street, Pro, or Race</div>
            </div>
            <div class="mode-card" onclick="selectMode('custom')">
                <div class="mode-icon">üîß</div>
                <div class="mode-title">Custom Build</div>
                <div class="mode-desc">Choose individual parts + engine swap</div>
            </div>
        </div>
        <div id="quickBuild" style="display:none;">
            <h2 style="color:var(--cyan);margin-bottom:16px;">Select Class</h2>
            <div class="class-grid" id="classGrid"></div>
        </div>
        <div id="customBuild" style="display:none;">
            <div class="parts-grid" id="partsGrid"></div>
        </div>
        <div class="btn-row">
            <button class="btn-outline" onclick="goStep(1)">‚Üê Upload Different Car</button>
            <button class="btn" id="generateBtn" onclick="generatePhysics()" style="display:none;">‚ö° Generate Physics</button>
        </div>
    </div>

    <!-- STEP 3: Results -->
    <div class="step" id="step3">
        <div class="car-banner" id="resultBanner"></div>
        <div class="summary-grid" id="summaryGrid"></div>
        <details class="comp-details">
            <summary>üìä Detailed Before / After Comparison</summary>
            <div id="comparisonTables"></div>
        </details>
        <div class="btn-row">
            <button class="btn-outline" onclick="goStep(2)">‚Üê Modify Parts</button>
            <button class="btn" onclick="downloadZip()">üì¶ Download Modified Data</button>
        </div>
    </div>

    <footer>RealiSimHQ ¬© 2025 ‚Äî Real parts, real physics.</footer>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATABASE ‚Äî Parts, Engine Swaps, Class Presets, Chassis Compatibility
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CHASSIS_CODES = {
    's13':['Nissan','240SX / Silvia (S13)','1989-1994'],
    's14':['Nissan','Silvia (S14)','1994-1998'],
    's15':['Nissan','Silvia (S15)','1999-2002'],
    '180sx':['Nissan','180SX','1989-1998'],
    'e46':['BMW','3 Series / M3 (E46)','1999-2006'],
    'e36':['BMW','M3 (E36)','1992-1999'],
    'ae86':['Toyota','AE86 Corolla','1983-1987'],
    'jza80':['Toyota','Supra (A80)','1993-2002'],
    'a80':['Toyota','Supra (A80)','1993-2002'],
    'fd3s':['Mazda','RX-7 (FD3S)','1992-2002'],
    'rx7':['Mazda','RX-7',''],
    'ap1':['Honda','S2000 (AP1)','1999-2003'],
    'ap2':['Honda','S2000 (AP2)','2004-2009'],
    'z33':['Nissan','350Z (Z33)','2002-2009'],
    'z34':['Nissan','370Z (Z34)','2009-2020'],
    'r34':['Nissan','Skyline GT-R (R34)','1999-2002'],
    'r33':['Nissan','Skyline GT-R (R33)','1995-1998'],
    'r32':['Nissan','Skyline GT-R (R32)','1989-1994'],
    'c6':['Chevrolet','Corvette (C6)','2005-2013'],
    'c5':['Chevrolet','Corvette (C5)','1997-2004'],
    'gdb':['Subaru','WRX STI (GDB)','2001-2007'],
    'gc8':['Subaru','WRX (GC8)','1992-2000'],
    'ct9a':['Mitsubishi','Lancer Evo IX','2005-2007'],
    'evo':['Mitsubishi','Lancer Evolution',''],
};

const KNOWN_MAKES = {
    'toyota':'Toyota','lexus':'Lexus','nissan':'Nissan','honda':'Honda',
    'mazda':'Mazda','subaru':'Subaru','mitsubishi':'Mitsubishi','bmw':'BMW',
    'mercedes':'Mercedes-Benz','audi':'Audi','porsche':'Porsche',
    'ford':'Ford','chevrolet':'Chevrolet','chevy':'Chevrolet',
    'corvette':'Chevrolet','dodge':'Dodge','ferrari':'Ferrari',
    'lamborghini':'Lamborghini','alfa':'Alfa Romeo','mclaren':'McLaren',
    'lotus':'Lotus','hyundai':'Hyundai','volvo':'Volvo',
};

// Platform groups for compatibility
const PLATFORM = {
    s_chassis: ['s13','s14','s15','180sx'],
    e46: ['e46'],
    ae86: ['ae86'],
    jza80: ['jza80','a80'],
    fd3s: ['fd3s'],
    s2000: ['ap1','ap2'],
    z33: ['z33'],
    z34: ['z34'],
    r34: ['r34'],
    r33: ['r33'],
    r32: ['r32'],
    skyline_r: ['r32','r33','r34'],
    c6: ['c6'],
    c5: ['c5'],
    gdb: ['gdb'],
    gc8: ['gc8'],
    evo: ['ct9a'],
};
const ALL_PLATFORMS = Object.values(PLATFORM).flat();

// ‚îÄ‚îÄ COILOVERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COILOVERS = {
    stock: { name:"Stock Suspension", brand:"OEM", description:"Factory springs and shocks",
        spring_rate_f_mult:1.0, spring_rate_r_mult:1.0, damping_quality:"basic", compatible:["all"] },
    bc_br: { name:"BC Racing BR Series", brand:"BC Racing", description:"30-way damping, entry-level adjustable",
        spring_rate_f_nm:44100, spring_rate_r_nm:33075, damping_quality:"adjustable", compatible:["all"] },
    tein_flex_z: { name:"Tein Flex Z", brand:"Tein", description:"16-way adjustable, steel body",
        spring_rate_f_nm:39240, spring_rate_r_nm:29430, damping_quality:"adjustable", compatible:["all"] },
    ksport_kontrol: { name:"KSport Kontrol Pro", brand:"KSport", description:"36-way adjustable, pillow ball mounts",
        spring_rate_f_nm:49050, spring_rate_r_nm:39240, damping_quality:"adjustable", compatible:["all"] },
    hks_hipermax: { name:"HKS Hipermax IV GT", brand:"HKS", description:"30-way adjustable, inverted monotube",
        spring_rate_f_nm:49050, spring_rate_r_nm:44100, damping_quality:"adjustable",
        compatible:[...PLATFORM.s_chassis,...PLATFORM.z33,...PLATFORM.skyline_r,...PLATFORM.jza80,...PLATFORM.fd3s,...PLATFORM.s2000,...PLATFORM.evo,...PLATFORM.gdb] },
    ohlins_rt: { name:"√ñhlins Road & Track", brand:"√ñhlins", description:"DFV technology, 20-way adjustable",
        spring_rate_f_nm:58860, spring_rate_r_nm:49050, damping_quality:"advanced",
        compatible:[...PLATFORM.s_chassis,...PLATFORM.e46,...PLATFORM.z33,...PLATFORM.jza80,...PLATFORM.fd3s,...PLATFORM.s2000,...PLATFORM.c6,...PLATFORM.evo,...PLATFORM.gdb,...PLATFORM.skyline_r] },
    kw_v3: { name:"KW Variant 3", brand:"KW", description:"Separate rebound/compression, inox-line",
        spring_rate_f_nm:53955, spring_rate_r_nm:44100, damping_quality:"advanced",
        compatible:[...PLATFORM.e46,...PLATFORM.c6,...PLATFORM.c5,...PLATFORM.z33,...PLATFORM.s2000,...PLATFORM.jza80,...PLATFORM.skyline_r] },
    fortune_500: { name:"Fortune Auto 500 Series", brand:"Fortune Auto", description:"24-way, swift springs, digressive valving",
        spring_rate_f_nm:58860, spring_rate_r_nm:49050, damping_quality:"advanced",
        compatible:[...PLATFORM.s_chassis,...PLATFORM.e46,...PLATFORM.z33,...PLATFORM.s2000,...PLATFORM.fd3s,...PLATFORM.jza80,...PLATFORM.ae86] },
    mca_blue: { name:"MCA Blue Series", brand:"MCA Suspension", description:"2-way adjustable, race-spec valving",
        spring_rate_f_nm:68670, spring_rate_r_nm:58860, damping_quality:"advanced",
        compatible:[...PLATFORM.s_chassis,...PLATFORM.e46,...PLATFORM.ae86,...PLATFORM.z33,...PLATFORM.skyline_r,...PLATFORM.fd3s,...PLATFORM.jza80,...PLATFORM.s2000] },
    bc_zr: { name:"BC Racing ZR Series", brand:"BC Racing", description:"3-way adjustable, remote reservoir",
        spring_rate_f_nm:78480, spring_rate_r_nm:68670, damping_quality:"advanced", compatible:["all"] },
    bilstein_b16: { name:"Bilstein B16 PSS10", brand:"Bilstein", description:"10-way adjustable, monotube",
        spring_rate_f_nm:44100, spring_rate_r_nm:34300, damping_quality:"adjustable",
        compatible:[...PLATFORM.e46,...PLATFORM.c6,...PLATFORM.z33,...PLATFORM.s2000] },
    tein_mono_sport: { name:"Tein Mono Sport", brand:"Tein", description:"16-way adjustable monotube, advanced valving",
        spring_rate_f_nm:53955, spring_rate_r_nm:44100, damping_quality:"advanced",
        compatible:[...PLATFORM.s_chassis,...PLATFORM.z33,...PLATFORM.skyline_r,...PLATFORM.jza80,...PLATFORM.evo,...PLATFORM.gdb,...PLATFORM.s2000,...PLATFORM.fd3s] },
};

// ‚îÄ‚îÄ ANGLE KITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ANGLE_KITS = {
    stock: { name:"Stock Steering", brand:"OEM", max_angle_deg:0, description:"Factory steering geometry",
        hub_mass_add_kg:0, compatible:["all"] },
    wisefab_lock: { name:"Wisefab Lock Kit", brand:"Wisefab", max_angle_deg:65,
        description:"Full kit ‚Äî new knuckles, extended LCA, tie rods", hub_mass_add_kg:2.5,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.e46,...PLATFORM.z33,...PLATFORM.skyline_r,...PLATFORM.jza80] },
    wisefab_fd: { name:"Wisefab FD Kit", brand:"Wisefab", max_angle_deg:60,
        description:"Full front knuckle replacement", hub_mass_add_kg:3.0,
        compatible:[...PLATFORM.fd3s] },
    megan_angle: { name:"Megan Racing Angle Kit", brand:"Megan Racing", max_angle_deg:50,
        description:"Tie rod + lower arm spacer kit", hub_mass_add_kg:1.0,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.z33,...PLATFORM.ae86] },
    drift_knuckles: { name:"Generic Drift Knuckles", brand:"Various", max_angle_deg:55,
        description:"Extended lower arm + modified knuckle", hub_mass_add_kg:1.5, compatible:["all"] },
    gktech_angle: { name:"GKTech Steering Angle Kit", brand:"GKTech", max_angle_deg:55,
        description:"CNC machined tie rod ends + spacers", hub_mass_add_kg:1.2,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.z33,...PLATFORM.skyline_r] },
};

// ‚îÄ‚îÄ WHEEL SETUPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WHEEL_SETUPS = {
    stock: { name:"Stock Wheels & Tires", brand:"OEM", description:"Factory wheel and tire setup", compatible:["all"] },
    "15x8_195": { name:"15√ó8 ET0 + 195/50R15", brand:"Rota / Konig", description:"Lightweight drift setup, narrow",
        rim_dia:15, rim_width:8, offset_mm:0, tire_width:0.195, tire_aspect:50, compatible:["all"] },
    "17x9_215": { name:"17√ó9 ET22 + 215/45R17", brand:"Work Emotion / Rays", description:"Standard drift fitment",
        rim_dia:17, rim_width:9, offset_mm:22, tire_width:0.215, tire_aspect:45, compatible:["all"] },
    "17x9_235": { name:"17√ó9 ET22 + 235/40R17", brand:"Work / SSR / Rays", description:"Wider drift fitment",
        rim_dia:17, rim_width:9, offset_mm:22, tire_width:0.235, tire_aspect:40, compatible:["all"] },
    "18x95_255": { name:"18√ó9.5 ET22 + 255/35R18", brand:"Rays / Advan / Work", description:"Wide grip fitment, 18-inch",
        rim_dia:18, rim_width:9.5, offset_mm:22, tire_width:0.255, tire_aspect:35, compatible:["all"] },
    "18x10_265": { name:"18√ó10 ET15 + 265/35R18", brand:"Volk TE37 / BBS", description:"Pro-level wide fitment",
        rim_dia:18, rim_width:10, offset_mm:15, tire_width:0.265, tire_aspect:35, compatible:["all"] },
    "18x105_275": { name:"18√ó10.5 ET12 + 275/35R18", brand:"Volk TE37 / Advan GT", description:"FD Pro Spec level, max grip",
        rim_dia:18, rim_width:10.5, offset_mm:12, tire_width:0.275, tire_aspect:35, compatible:["all"] },
    "19x10_275": { name:"19√ó10 ET25 + 275/30R19", brand:"BBS / HRE / Forgeline", description:"Big wheel performance fitment",
        rim_dia:19, rim_width:10, offset_mm:25, tire_width:0.275, tire_aspect:30,
        compatible:[...PLATFORM.c6,...PLATFORM.c5,...PLATFORM.e46,...PLATFORM.jza80,...PLATFORM.skyline_r,...PLATFORM.z33] },
};

// ‚îÄ‚îÄ BRAKE KITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BRAKE_KITS = {
    stock: { name:"Stock Brakes", brand:"OEM", description:"Factory brake system", compatible:["all"] },
    z32_swap: { name:"Z32 4-Pot Caliper Swap", brand:"Nissan OEM", description:"300ZX front caliper upgrade",
        torque_mult:1.30, bias:0.64, mass_add_f_kg:3.0,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.ae86,...PLATFORM.z33] },
    wilwood_dynapro: { name:"Wilwood Dynapro 4-Piston", brand:"Wilwood", description:"Lightweight 4-piston forged caliper",
        torque_mult:1.40, bias:0.64, mass_add_f_kg:1.5, compatible:["all"] },
    ap_5200: { name:"AP Racing CP5200", brand:"AP Racing", description:"Pro-level 4-piston endurance caliper",
        torque_mult:1.55, bias:0.65, mass_add_f_kg:2.0, compatible:["all"] },
    brembo_gt: { name:"Brembo GT 6-Piston", brand:"Brembo", description:"6-piston monobloc, 380mm rotor",
        torque_mult:1.80, bias:0.66, mass_add_f_kg:4.0, compatible:["all"] },
    stoptech_trophy: { name:"StopTech Trophy Race", brand:"StopTech", description:"Asymmetric 4-piston, 355mm rotor",
        torque_mult:1.60, bias:0.65, mass_add_f_kg:2.5, compatible:["all"] },
    r33_gtr_swap: { name:"R33 GTR Brembo Swap", brand:"Nissan/Brembo OEM", description:"4-pot Brembo from R33 GT-R",
        torque_mult:1.45, bias:0.64, mass_add_f_kg:3.5,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.skyline_r,...PLATFORM.z33] },
};

// ‚îÄ‚îÄ DIFFERENTIALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DIFF_TYPES = {
    stock: { name:"Stock Differential", brand:"OEM", description:"Factory differential", compatible:["all"] },
    kaaz_15: { name:"Kaaz 1.5-Way LSD", brand:"Kaaz", description:"1.5-way clutch-type, strong power lock",
        diff_power:0.75, diff_coast:0.35, diff_preload:60, compatible:["all"] },
    kaaz_2way: { name:"Kaaz 2-Way LSD", brand:"Kaaz", description:"Full 2-way clutch-type, drift spec",
        diff_power:0.90, diff_coast:0.55, diff_preload:80, compatible:["all"] },
    os_giken: { name:"OS Giken Super Lock", brand:"OS Giken", description:"Multi-plate, progressive lockup",
        diff_power:0.85, diff_coast:0.45, diff_preload:70,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.skyline_r,...PLATFORM.jza80,...PLATFORM.z33,...PLATFORM.fd3s,...PLATFORM.ae86,...PLATFORM.s2000] },
    cusco_rs: { name:"Cusco RS 1.5-Way", brand:"Cusco", description:"1.5-way clutch-type, street/track",
        diff_power:0.65, diff_coast:0.30, diff_preload:50, compatible:["all"] },
    cusco_mz: { name:"Cusco Type MZ 2-Way", brand:"Cusco", description:"Full 2-way, drift competition spec",
        diff_power:0.95, diff_coast:0.60, diff_preload:90, compatible:["all"] },
    welded: { name:"Welded / Spool", brand:"N/A", description:"Fully locked (welded or mini spool)",
        diff_power:1.0, diff_coast:1.0, diff_preload:200, compatible:["all"] },
    wavetrac: { name:"Wavetrac ATB LSD", brand:"Wavetrac", description:"Gear-type ATB, progressive lock on decel",
        diff_power:0.45, diff_coast:0.35, diff_preload:25,
        compatible:[...PLATFORM.e46,...PLATFORM.c6,...PLATFORM.s2000,...PLATFORM.z33,...PLATFORM.gdb,...PLATFORM.evo] },
    drexler: { name:"Drexler Motorsport LSD", brand:"Drexler", description:"Preload-adjustable clutch LSD, race-grade",
        diff_power:0.80, diff_coast:0.50, diff_preload:75,
        compatible:[...PLATFORM.e46,...PLATFORM.c6,...PLATFORM.jza80,...PLATFORM.fd3s,...PLATFORM.s2000,...PLATFORM.skyline_r] },
};

// ‚îÄ‚îÄ TIRE COMPOUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TIRE_COMPOUNDS = {
    street: { name:"All-Season / Street", grip_mult:1.10, dx_ref:1.28, dy_ref:1.28, compatible:["all"] },
    "200tw": { name:"200TW (Hankook RS4 / Federal 595)", grip_mult:1.25, dx_ref:1.35, dy_ref:1.35, compatible:["all"] },
    semi_slick: { name:"Semi-Slick (RE-71RS / AD09 / RT660)", grip_mult:1.38, dx_ref:1.44, dy_ref:1.44, compatible:["all"] },
    slick: { name:"Racing Slick (Hoosier / Nitto NT01)", grip_mult:1.50, dx_ref:1.55, dy_ref:1.55, compatible:["all"] },
};

// ‚îÄ‚îÄ ENGINE SWAPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ENGINE_SWAPS = {
    stock: { name:"Stock Engine", brand:"OEM", description:"Keep original engine", weight_kg:0, weight_dist_shift:0,
        power_mult:1.0, compatible:["all"] },
    sr20det: { name:"SR20DET", brand:"Nissan", description:"2.0L turbo I4 ‚Äî 205-350hp range",
        weight_kg:165, stock_weight_kg:165, weight_dist_shift:0, power_mult:1.0,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.ae86],
        native:[...PLATFORM.s_chassis] },
    rb26dett: { name:"RB26DETT", brand:"Nissan", description:"2.6L twin-turbo I6 ‚Äî 280-600hp range",
        weight_kg:250, stock_weight_kg:250, weight_dist_shift:0.02, power_mult:1.3,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.skyline_r,...PLATFORM.z33,...PLATFORM.jza80],
        native:[...PLATFORM.skyline_r] },
    rb25det: { name:"RB25DET", brand:"Nissan", description:"2.5L turbo I6 ‚Äî 250-450hp, budget RB option",
        weight_kg:230, stock_weight_kg:230, weight_dist_shift:0.015, power_mult:1.15,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.skyline_r,...PLATFORM.z33],
        native:['r33'] },
    "2jz_gte": { name:"2JZ-GTE", brand:"Toyota", description:"3.0L twin-turbo I6 ‚Äî 321-1000+hp, legendary swap",
        weight_kg:265, stock_weight_kg:265, weight_dist_shift:0.025, power_mult:1.4,
        compatible:[...PLATFORM.s_chassis,...PLATFORM.jza80,...PLATFORM.ae86,...PLATFORM.z33,...PLATFORM.e46,...PLATFORM.skyline_r,...PLATFORM.fd3s,...PLATFORM.s2000],
        native:[...PLATFORM.jza80] },
    ls1: { name:"LS1 (5.7L V8)", brand:"GM", description:"5.7L V8 ‚Äî 350-500hp, compact aluminum V8",
        weight_kg:210, stock_weight_kg:0, weight_dist_shift:-0.01, power_mult:1.5,
        compatible:["all"], native:[...PLATFORM.c5] },
    ls3: { name:"LS3 (6.2L V8)", brand:"GM", description:"6.2L V8 ‚Äî 430-600hp, modern LS swap king",
        weight_kg:215, stock_weight_kg:0, weight_dist_shift:-0.01, power_mult:1.7,
        compatible:["all"], native:[...PLATFORM.c6] },
    k20a: { name:"K20A", brand:"Honda", description:"2.0L VTEC I4 ‚Äî 220-300hp, high-rev NA power",
        weight_kg:135, stock_weight_kg:135, weight_dist_shift:-0.02, power_mult:1.1,
        compatible:[...PLATFORM.s2000,...PLATFORM.ae86,...PLATFORM.s_chassis],
        native:[] },
    k24: { name:"K24A2 (Turbo)", brand:"Honda", description:"2.4L I4 turbo build ‚Äî 300-500hp, popular swap",
        weight_kg:145, stock_weight_kg:145, weight_dist_shift:-0.015, power_mult:1.35,
        compatible:[...PLATFORM.s2000,...PLATFORM.ae86,...PLATFORM.s_chassis],
        native:[] },
    "13b_rew": { name:"13B-REW", brand:"Mazda", description:"1.3L twin-turbo rotary ‚Äî 255-450hp",
        weight_kg:140, stock_weight_kg:140, weight_dist_shift:-0.02, power_mult:1.2,
        compatible:[...PLATFORM.fd3s,...PLATFORM.ae86,...PLATFORM.s_chassis],
        native:[...PLATFORM.fd3s] },
    ej257: { name:"EJ257", brand:"Subaru", description:"2.5L turbo boxer-4 ‚Äî 305-450hp, STI motor",
        weight_kg:195, stock_weight_kg:195, weight_dist_shift:0, power_mult:1.15,
        compatible:[...PLATFORM.gdb,...PLATFORM.gc8],
        native:[...PLATFORM.gdb] },
    "4g63t": { name:"4G63T", brand:"Mitsubishi", description:"2.0L turbo I4 ‚Äî 280-500hp, Evo motor",
        weight_kg:175, stock_weight_kg:175, weight_dist_shift:0, power_mult:1.15,
        compatible:[...PLATFORM.evo,...PLATFORM.ae86,...PLATFORM.s_chassis],
        native:[...PLATFORM.evo] },
};

// ‚îÄ‚îÄ CLASS PRESETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CLASS_PRESETS = {
    factory: { label:"Factory", hp:"100-300hp", desc:"Stock-class, OEM feel",
        coilovers:"stock",angle_kit:"stock",wheels:"stock",brakes:"stock",diff:"stock",tire_compound:"street",engine_swap:"stock" },
    grassroots: { label:"Grassroots", hp:"180-350hp", desc:"Budget build, weekend warrior",
        coilovers:"bc_br",angle_kit:"megan_angle",wheels:"17x9_215",brakes:"z32_swap",diff:"cusco_rs",tire_compound:"200tw",engine_swap:"stock" },
    street: { label:"Street", hp:"240-500hp", desc:"Serious street build",
        coilovers:"ohlins_rt",angle_kit:"wisefab_lock",wheels:"17x9_235",brakes:"wilwood_dynapro",diff:"kaaz_15",tire_compound:"semi_slick",engine_swap:"stock" },
    pro: { label:"Pro", hp:"500-800hp", desc:"Formula Drift / Pro-Am spec",
        coilovers:"mca_blue",angle_kit:"wisefab_lock",wheels:"18x10_265",brakes:"ap_5200",diff:"kaaz_2way",tire_compound:"slick",engine_swap:"stock" },
    race: { label:"Race", hp:"300-600hp", desc:"Time attack / endurance",
        coilovers:"bc_zr",angle_kit:"stock",wheels:"18x95_255",brakes:"brembo_gt",diff:"os_giken",tire_compound:"slick",engine_swap:"stock" },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INI PARSER (client-side)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function parseIni(text) {
    const sections = {};
    let cur = null;
    for (const raw of text.split('\n')) {
        const line = raw.trim();
        if (!line || line.startsWith(';') || line.startsWith('#')) continue;
        const sm = line.match(/^\[(.+)\]$/);
        if (sm) { cur = sm[1]; if (!sections[cur]) sections[cur] = {}; continue; }
        if (!cur) continue;
        const kv = line.match(/^([A-Za-z0-9_]+)\s*=\s*(.*?)(?:\s*;.*)?$/);
        if (kv) {
            let val = kv[2].trim();
            const f = parseFloat(val);
            sections[cur][kv[1]] = isNaN(f) ? val : (val.includes('.') ? f : (Number.isInteger(f) ? parseInt(val) : f));
        }
    }
    return sections;
}

function getVal(sections, section, key, def) {
    if (sections[section] && sections[section][key] !== undefined) return sections[section][key];
    return def;
}

function applyChanges(content, sectionChanges) {
    for (const [section, vals] of Object.entries(sectionChanges)) {
        for (const [key, newVal] of Object.entries(vals)) {
            const pat = new RegExp(`((?:^|\\n)(\\s*)${key.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\s*=)\\s*[^\\n;]*`, 'i');
            const replaced = content.replace(pat, `$1${newVal}`);
            if (replaced !== content) { content = replaced; }
            else {
                // Try to insert in section
                const secPat = new RegExp(`(\\[${section.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\][^\\[]*)`, 'i');
                content = content.replace(secPat, (m) => m.trimEnd() + `\n${key}=${newVal}\n`);
            }
        }
    }
    return content;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let state = {
    step: 1,
    rawFiles: {},       // filename -> raw text content
    parsed: {},         // filename -> parsed sections
    stock: {},          // extracted stock values
    carInfo: {},        // detected car info
    detectedChassis: null,
    mode: null,         // 'quick' or 'custom'
    classKey: null,
    selectedParts: { coilovers:'stock', angle_kit:'stock', wheels:'stock', brakes:'stock', diff:'stock', tire_compound:'street', engine_swap:'stock' },
    result: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAR DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function detectCar(parsed, rawFiles) {
    const car = parsed['car.ini'] || {};
    const susp = parsed['suspensions.ini'] || {};
    const dt = parsed['drivetrain.ini'] || {};
    const tyres = parsed['tyres.ini'] || {};
    const brakes = parsed['brakes.ini'] || {};

    const screenName = getVal(car, 'INFO', 'SCREEN_NAME', '') || getVal(car, 'HEADER', 'SCREEN_NAME', '');
    const shortName = getVal(car, 'INFO', 'SHORT_NAME', '');

    // Detect chassis
    let chassis = null, make = 'Unknown', model = 'Unknown', year = '';
    const nameToCheck = (screenName + ' ' + shortName).toLowerCase().replace(/[-\s]/g, '');
    for (const [code, info] of Object.entries(CHASSIS_CODES)) {
        if (nameToCheck.includes(code.replace(/[-\s]/g, ''))) {
            chassis = code; make = info[0]; model = info[1]; year = info[2];
            break;
        }
    }
    if (!chassis) {
        for (const [alias, mk] of Object.entries(KNOWN_MAKES)) {
            if (nameToCheck.includes(alias)) { make = mk; model = screenName || shortName || 'Unknown'; break; }
        }
    }

    const stock = {
        total_mass: getVal(car, 'BASIC', 'TOTALMASS', 1300),
        steer_lock: getVal(car, 'CONTROLS', 'STEER_LOCK', 450),
        steer_ratio: getVal(car, 'CONTROLS', 'STEER_RATIO', 16),
        screen_name: screenName || shortName || 'Unknown Car',
        wheelbase: getVal(susp, 'BASIC', 'WHEELBASE', 2.5),
        cg_location: getVal(susp, 'BASIC', 'CG_LOCATION', 0.55),
        spring_rate_f: getVal(susp, 'FRONT', 'SPRING_RATE', 30000),
        spring_rate_r: getVal(susp, 'REAR', 'SPRING_RATE', 25000),
        hub_mass_f: getVal(susp, 'FRONT', 'HUB_MASS', 35),
        hub_mass_r: getVal(susp, 'REAR', 'HUB_MASS', 30),
        track_f: getVal(susp, 'FRONT', 'TRACK', 1.48),
        track_r: getVal(susp, 'REAR', 'TRACK', 1.48),
        arb_f: getVal(susp, 'ARB', 'FRONT', 20000),
        arb_r: getVal(susp, 'ARB', 'REAR', 10000),
        damp_bump_f: getVal(susp, 'FRONT', 'DAMP_BUMP', 3000),
        damp_rebound_f: getVal(susp, 'FRONT', 'DAMP_REBOUND', 5000),
        damp_bump_r: getVal(susp, 'REAR', 'DAMP_BUMP', 2500),
        damp_rebound_r: getVal(susp, 'REAR', 'DAMP_REBOUND', 4500),
        tire_width_f: getVal(tyres, 'FRONT', 'WIDTH', 0.225),
        tire_width_r: getVal(tyres, 'REAR', 'WIDTH', 0.225),
        tire_radius_f: getVal(tyres, 'FRONT', 'RADIUS', 0.31),
        tire_radius_r: getVal(tyres, 'REAR', 'RADIUS', 0.31),
        grip_f: getVal(tyres, 'FRONT', 'FRICTION_LIMIT_GRIP', 1.0),
        dx_ref_f: getVal(tyres, 'FRONT', 'DX_REF', 1.28),
        dy_ref_f: getVal(tyres, 'FRONT', 'DY_REF', 1.28),
        brake_torque: getVal(brakes, 'DATA', 'MAX_TORQUE', 2000),
        brake_bias: getVal(brakes, 'DATA', 'FRONT_SHARE', 0.62),
        drivetrain_type: getVal(dt, 'TRACTION', 'TYPE', 'RWD'),
        diff_power: getVal(dt, 'DIFFERENTIAL', 'POWER', 0.0),
        diff_coast: getVal(dt, 'DIFFERENTIAL', 'COAST', 0.0),
        diff_preload: getVal(dt, 'DIFFERENTIAL', 'PRELOAD', 0),
        susp_type_f: getVal(susp, 'FRONT', 'TYPE', 'STRUT'),
        susp_type_r: getVal(susp, 'REAR', 'TYPE', 'STRUT'),
    };

    // Derived values
    const wdf = stock.cg_location > 0 ? stock.cg_location : 0.55;
    stock.weight_dist_f = wdf;
    const sprungTotal = stock.total_mass - (stock.hub_mass_f*2 + stock.hub_mass_r*2);
    stock.sprung_f_corner = Math.round(sprungTotal * wdf / 2 * 10) / 10;
    stock.sprung_r_corner = Math.round(sprungTotal * (1-wdf) / 2 * 10) / 10;
    stock.stock_max_angle = stock.steer_ratio > 0 && stock.steer_lock > 0 ? Math.round(stock.steer_lock / stock.steer_ratio * 10) / 10 : 35;
    const natFreq = (k, m) => m > 0 && k > 0 ? Math.round((1/(2*Math.PI)) * Math.sqrt(k/m) * 100) / 100 : 0;
    stock.nat_freq_f = natFreq(stock.spring_rate_f, stock.sprung_f_corner);
    stock.nat_freq_r = natFreq(stock.spring_rate_r, stock.sprung_r_corner);

    return { chassis, make, model, year, stock, name: screenName || model };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPATIBILITY CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function isCompatible(part, chassis) {
    if (!part.compatible || part.compatible.includes('all')) return true;
    if (!chassis) return true; // Can't filter if unknown
    return part.compatible.includes(chassis);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHYSICS CALCULATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calculatePhysics(stock, parts) {
    const coilover = COILOVERS[parts.coilovers] || COILOVERS.stock;
    const angleKit = ANGLE_KITS[parts.angle_kit] || ANGLE_KITS.stock;
    const wheels = WHEEL_SETUPS[parts.wheels] || WHEEL_SETUPS.stock;
    const brakeKit = BRAKE_KITS[parts.brakes] || BRAKE_KITS.stock;
    const diff = DIFF_TYPES[parts.diff] || DIFF_TYPES.stock;
    const compound = TIRE_COMPOUNDS[parts.tire_compound] || TIRE_COMPOUNDS.street;
    const engine = ENGINE_SWAPS[parts.engine_swap] || ENGINE_SWAPS.stock;

    let totalMass = stock.total_mass;
    let wdf = stock.weight_dist_f;

    // Engine swap mass/balance changes
    if (parts.engine_swap !== 'stock' && engine.weight_kg) {
        // If it's native to this platform, no mass change. Otherwise estimate delta.
        const isNative = engine.native && state.detectedChassis && engine.native.includes(state.detectedChassis);
        if (!isNative) {
            // Rough estimate: assume stock engine ~same category weight, apply delta
            const stockEngWeight = engine.stock_weight_kg || 180;
            const delta = engine.weight_kg - stockEngWeight;
            totalMass += delta;
        }
        wdf += engine.weight_dist_shift;
        wdf = Math.max(0.40, Math.min(0.65, wdf));
    }

    // Springs
    let springF, springR;
    if (coilover.spring_rate_f_nm) { springF = coilover.spring_rate_f_nm; springR = coilover.spring_rate_r_nm; }
    else { springF = stock.spring_rate_f * (coilover.spring_rate_f_mult || 1); springR = stock.spring_rate_r * (coilover.spring_rate_r_mult || 1); }

    // Hub mass
    const hubF = stock.hub_mass_f + (brakeKit.mass_add_f_kg || 0) + (angleKit.hub_mass_add_kg || 0);
    const hubR = stock.hub_mass_r;

    const sprungTotal = totalMass - (hubF*2 + hubR*2);
    const sprungF = sprungTotal * wdf / 2;
    const sprungR = sprungTotal * (1-wdf) / 2;

    const natFreq = (k,m) => m > 0 && k > 0 ? Math.round((1/(2*Math.PI))*Math.sqrt(k/m)*100)/100 : 0;
    const freqF = natFreq(springF, sprungF);
    const freqR = natFreq(springR, sprungR);

    // Damping
    const dq = coilover.damping_quality || 'basic';
    const ratios = { basic:[0.22,0.35], adjustable:[0.25,0.40], advanced:[0.28,0.45] };
    const [br, rr] = ratios[dq] || ratios.adjustable;
    const calcDamp = (k, m, bR, rR) => {
        const cc = 2 * Math.sqrt(k * m);
        return { bump: Math.round(cc*bR), fast_bump: Math.round(cc*bR*0.5), rebound: Math.round(cc*rR), fast_rebound: Math.round(cc*rR*0.5) };
    };
    const dampF = calcDamp(springF, sprungF, br, rr);
    const dampR = calcDamp(springR, sprungR, br, rr);

    // ARB
    const arbF = Math.round(stock.arb_f * springF / Math.max(stock.spring_rate_f, 1));
    const arbR = Math.round(stock.arb_r * springR / Math.max(stock.spring_rate_r, 1));

    // Steering
    let maxAngle, steerLock;
    if (angleKit.max_angle_deg > 0) { maxAngle = angleKit.max_angle_deg; steerLock = maxAngle * stock.steer_ratio; }
    else { maxAngle = stock.stock_max_angle; steerLock = stock.steer_lock; }

    // Brakes
    let brakeTorque = stock.brake_torque, brakeBias = stock.brake_bias;
    if (brakeKit.torque_mult) { brakeTorque = Math.round(stock.brake_torque * brakeKit.torque_mult); brakeBias = brakeKit.bias; }

    // Diff
    const diffPower = diff.diff_power !== undefined ? diff.diff_power : stock.diff_power;
    const diffCoast = diff.diff_coast !== undefined ? diff.diff_coast : stock.diff_coast;
    const diffPreload = diff.diff_preload !== undefined ? diff.diff_preload : stock.diff_preload;

    // Tires
    const tireWF = wheels.tire_width || stock.tire_width_f;
    const tireWR = wheels.tire_width || stock.tire_width_r;
    let tireRF = stock.tire_radius_f, tireRR = stock.tire_radius_r;
    if (wheels.rim_dia) {
        const tr = (w, asp, rim) => w * (asp/100) + (rim * 0.0254)/2;
        tireRF = Math.round(tr(tireWF, wheels.tire_aspect||45, wheels.rim_dia)*10000)/10000;
        tireRR = Math.round(tr(tireWR, wheels.tire_aspect||45, wheels.rim_dia)*10000)/10000;
    }

    // Comparison
    const comparison = [
        {param:"Total Mass", stock:`${stock.total_mass} kg`, modified:`${totalMass} kg`, category:"chassis"},
        {param:"Weight Dist (F)", stock:`${(stock.weight_dist_f*100).toFixed(1)}%`, modified:`${(wdf*100).toFixed(1)}%`, category:"chassis"},
        {param:"Spring Rate (F)", stock:`${stock.spring_rate_f.toLocaleString()} N/m`, modified:`${Math.round(springF).toLocaleString()} N/m`, category:"suspension"},
        {param:"Spring Rate (R)", stock:`${stock.spring_rate_r.toLocaleString()} N/m`, modified:`${Math.round(springR).toLocaleString()} N/m`, category:"suspension"},
        {param:"Natural Freq (F)", stock:`${stock.nat_freq_f} Hz`, modified:`${freqF} Hz`, category:"suspension"},
        {param:"Natural Freq (R)", stock:`${stock.nat_freq_r} Hz`, modified:`${freqR} Hz`, category:"suspension"},
        {param:"ARB (F)", stock:`${stock.arb_f.toLocaleString()} N/m`, modified:`${arbF.toLocaleString()} N/m`, category:"suspension"},
        {param:"ARB (R)", stock:`${stock.arb_r.toLocaleString()} N/m`, modified:`${arbR.toLocaleString()} N/m`, category:"suspension"},
        {param:"Hub Mass (F)", stock:`${stock.hub_mass_f} kg`, modified:`${Math.round(hubF*10)/10} kg`, category:"unsprung"},
        {param:"Max Steering Angle", stock:`${stock.stock_max_angle}¬∞`, modified:`${maxAngle}¬∞`, category:"steering"},
        {param:"Steer Lock", stock:`${stock.steer_lock}¬∞`, modified:`${Math.round(steerLock)}¬∞`, category:"steering"},
        {param:"Tire Width (F)", stock:`${(stock.tire_width_f*1000).toFixed(0)}mm`, modified:`${(tireWF*1000).toFixed(0)}mm`, category:"tires"},
        {param:"Tire Width (R)", stock:`${(stock.tire_width_r*1000).toFixed(0)}mm`, modified:`${(tireWR*1000).toFixed(0)}mm`, category:"tires"},
        {param:"Grip Level", stock:`${stock.grip_f}`, modified:`${compound.grip_mult}`, category:"tires"},
        {param:"Brake Torque", stock:`${stock.brake_torque} Nm`, modified:`${brakeTorque} Nm`, category:"brakes"},
        {param:"Brake Bias", stock:`${(stock.brake_bias*100).toFixed(0)}% F`, modified:`${(brakeBias*100).toFixed(0)}% F`, category:"brakes"},
        {param:"Diff Power Lock", stock:`${(stock.diff_power*100).toFixed(0)}%`, modified:`${(diffPower*100).toFixed(0)}%`, category:"diff"},
        {param:"Diff Coast Lock", stock:`${(stock.diff_coast*100).toFixed(0)}%`, modified:`${(diffCoast*100).toFixed(0)}%`, category:"diff"},
        {param:"Diff Preload", stock:`${stock.diff_preload} Nm`, modified:`${diffPreload} Nm`, category:"diff"},
    ];

    // INI changes
    const changes = {
        "car.ini": { BASIC: { TOTALMASS: totalMass }, CONTROLS: { STEER_LOCK: Math.round(steerLock) } },
        "suspensions.ini": {
            BASIC: { CG_LOCATION: Math.round(wdf*1000)/1000 },
            FRONT: { HUB_MASS: Math.round(hubF*10000)/10000, SPRING_RATE: Math.round(springF) },
            REAR: { HUB_MASS: Math.round(hubR*10000)/10000, SPRING_RATE: Math.round(springR) },
            ARB: { FRONT: arbF, REAR: arbR },
        },
        "tyres.ini": {
            FRONT: { WIDTH: tireWF, RADIUS: tireRF, FRICTION_LIMIT_GRIP: compound.grip_mult, DX_REF: compound.dx_ref, DY_REF: compound.dy_ref },
            REAR: { WIDTH: tireWR, RADIUS: tireRR, FRICTION_LIMIT_GRIP: compound.grip_mult, DX_REF: compound.dx_ref, DY_REF: compound.dy_ref },
        },
        "brakes.ini": { DATA: { MAX_TORQUE: brakeTorque, FRONT_SHARE: brakeBias, HANDBRAKE_TORQUE: Math.round(brakeTorque*0.25) } },
        "drivetrain.ini": { DIFFERENTIAL: { POWER: diffPower, COAST: diffCoast, PRELOAD: diffPreload } },
    };

    return {
        summary: {
            total_mass: totalMass, weight_dist_f: wdf,
            sprung_f_corner: Math.round(sprungF*10)/10, sprung_r_corner: Math.round(sprungR*10)/10,
            natural_freq_f: freqF, natural_freq_r: freqR,
            hub_mass_f: Math.round(hubF*10)/10, hub_mass_r: Math.round(hubR*10)/10,
            max_angle: maxAngle,
            engine: engine.name,
            parts: {
                coilovers: (COILOVERS[parts.coilovers]||{}).name||'Stock',
                angle_kit: (ANGLE_KITS[parts.angle_kit]||{}).name||'Stock',
                wheels: (WHEEL_SETUPS[parts.wheels]||{}).name||'Stock',
                brakes: (BRAKE_KITS[parts.brakes]||{}).name||'Stock',
                diff: (DIFF_TYPES[parts.diff]||{}).name||'Stock',
                tire_compound: compound.name,
                engine_swap: engine.name,
            },
        },
        changes, comparison,
    };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function goStep(n) {
    state.step = n;
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step'+n).classList.add('active');
    document.querySelectorAll('.progress-dot').forEach(d => {
        const ds = +d.dataset.step;
        d.className = 'progress-dot' + (ds<n?' done':ds===n?' current':'');
    });
    window.scrollTo({top:0,behavior:'smooth'});
}

// Drop zone
const dz = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const folderInput = document.getElementById('folderInput');
dz.addEventListener('click', e => { if (e.shiftKey) folderInput.click(); else fileInput.click(); });
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); handleDrop(e.dataTransfer); });
fileInput.addEventListener('change', e => processFiles(Array.from(e.target.files)));
folderInput.addEventListener('change', e => processFiles(Array.from(e.target.files)));

async function handleDrop(dt) {
    const items = dt.items;
    if (items && items.length > 0 && items[0].webkitGetAsEntry) {
        const allFiles = [];
        const promises = [];
        for (const item of items) {
            const entry = item.webkitGetAsEntry();
            if (entry) promises.push(traverseEntry(entry, allFiles));
        }
        await Promise.all(promises);
        if (allFiles.length > 0) { processFiles(allFiles); return; }
    }
    processFiles(Array.from(dt.files));
}

function traverseEntry(entry, result) {
    return new Promise(resolve => {
        if (entry.isFile) {
            entry.file(f => { f._path = entry.fullPath; result.push(f); resolve(); });
        } else if (entry.isDirectory) {
            const reader = entry.createReader();
            reader.readEntries(async entries => {
                for (const e of entries) await traverseEntry(e, result);
                resolve();
            });
        } else resolve();
    });
}

async function processFiles(files) {
    const iniFiles = files.filter(f => {
        const n = (f._path || f.webkitRelativePath || f.name).toLowerCase();
        return n.endsWith('.ini') || n.endsWith('.lut');
    });
    if (!iniFiles.length) {
        setDropMsg('‚ùå', 'No .ini files found!', 'Try again with different files');
        setTimeout(() => setDropMsg('üìÅ', "Drop your car's data folder here", 'Drag & drop a folder or individual .ini files'), 3000);
        return;
    }
    setDropMsg('‚è≥', `Reading ${iniFiles.length} files...`, 'Parsing physics data...');
    dz.classList.add('loading');

    state.rawFiles = {};
    state.parsed = {};
    for (const f of iniFiles) {
        const name = f.name.toLowerCase();
        const text = await f.text();
        state.rawFiles[name] = text;
        if (name.endsWith('.ini')) state.parsed[name] = parseIni(text);
    }

    if (!state.parsed['car.ini'] && !state.parsed['suspensions.ini']) {
        setDropMsg('‚ùå', 'No car.ini or suspensions.ini found', 'Make sure you upload from the data/ folder');
        dz.classList.remove('loading');
        setTimeout(() => setDropMsg('üìÅ', "Drop your car's data folder here", 'Drag & drop a folder or individual .ini files'), 3000);
        return;
    }

    const detected = detectCar(state.parsed, state.rawFiles);
    state.stock = detected.stock;
    state.carInfo = detected;
    state.detectedChassis = detected.chassis;

    dz.classList.remove('loading');
    setDropMsg('üèéÔ∏è', `‚úÖ ${detected.name} ‚Äî ${Object.keys(state.rawFiles).length} files loaded`, 'Proceeding to build selection...');

    state.selectedParts = { coilovers:'stock', angle_kit:'stock', wheels:'stock', brakes:'stock', diff:'stock', tire_compound:'street', engine_swap:'stock' };
    state.mode = null;
    state.classKey = null;

    setTimeout(() => { renderCarBanner(); goStep(2); }, 600);
}

function setDropMsg(icon, title, sub) {
    dz.querySelector('.icon').textContent = icon;
    dz.querySelector('.title').textContent = title;
    dz.querySelector('.subtitle').textContent = sub;
}

function renderCarBanner() {
    const s = state.stock; const c = state.carInfo;
    document.getElementById('carBanner').innerHTML = `
        <div>
            <div class="name">${c.name || c.model || 'Unknown Car'}</div>
            <div class="detail">${c.make} ${c.model}${c.chassis ? ' ¬∑ '+c.chassis.toUpperCase() : ''}${c.year ? ' ¬∑ '+c.year : ''}</div>
        </div>
        <div class="stats">
            <span class="stat">${s.total_mass} kg</span>
            <span class="stat">${s.drivetrain_type}</span>
            <span class="stat">${(s.weight_dist_f*100).toFixed(0)}/${(100-s.weight_dist_f*100).toFixed(0)} F/R</span>
        </div>`;
    // Reset mode display
    document.getElementById('modeSelect').style.display = 'grid';
    document.getElementById('quickBuild').style.display = 'none';
    document.getElementById('customBuild').style.display = 'none';
    document.getElementById('generateBtn').style.display = 'none';
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
}

function selectMode(mode) {
    state.mode = mode;
    document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('generateBtn').style.display = 'inline-flex';

    if (mode === 'quick') {
        document.getElementById('quickBuild').style.display = 'block';
        document.getElementById('customBuild').style.display = 'none';
        renderClassGrid();
    } else {
        document.getElementById('quickBuild').style.display = 'none';
        document.getElementById('customBuild').style.display = 'block';
        renderCustomParts();
    }
}

function renderClassGrid() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';
    for (const [key, cls] of Object.entries(CLASS_PRESETS)) {
        const div = document.createElement('div');
        div.className = 'class-card' + (state.classKey === key ? ' selected' : '');
        div.innerHTML = `<div class="class-name">${cls.label}</div><div class="class-hp">${cls.hp}</div><div class="class-desc">${cls.desc}</div>`;
        div.onclick = () => {
            state.classKey = key;
            // Map class preset to parts selection
            state.selectedParts = {
                coilovers: cls.coilovers, angle_kit: cls.angle_kit, wheels: cls.wheels,
                brakes: cls.brakes, diff: cls.diff, tire_compound: cls.tire_compound, engine_swap: cls.engine_swap,
            };
            renderClassGrid();
        };
        grid.appendChild(div);
    }
}

function renderCustomParts() {
    const grid = document.getElementById('partsGrid');
    grid.innerHTML = '';
    const chassis = state.detectedChassis;

    const groups = [
        { key:'coilovers', title:'üîß Coilovers', data:COILOVERS, pk:'coilovers',
            spec: c => c.spring_rate_f_nm ? `${Math.round(c.spring_rate_f_nm/9810)}/${Math.round(c.spring_rate_r_nm/9810)} kg/mm` : 'Stock rates' },
        { key:'angle_kits', title:'üîÑ Angle Kit', data:ANGLE_KITS, pk:'angle_kit',
            spec: c => c.max_angle_deg > 0 ? `${c.max_angle_deg}¬∞ max` : 'Stock angle' },
        { key:'engine_swaps', title:'üî• Engine Swap', data:ENGINE_SWAPS, pk:'engine_swap',
            spec: c => c.weight_kg ? `${c.weight_kg}kg, √ó${c.power_mult} power` : 'No change' },
        { key:'wheels', title:'üõû Wheels & Tires', data:WHEEL_SETUPS, pk:'wheels',
            spec: c => c.rim_dia ? `${c.rim_dia}√ó${c.rim_width} ET${c.offset_mm}` : 'Stock' },
        { key:'brakes', title:'üõë Brakes', data:BRAKE_KITS, pk:'brakes',
            spec: c => c.torque_mult ? `+${Math.round((c.torque_mult-1)*100)}% torque` : 'Stock' },
        { key:'diffs', title:'‚öôÔ∏è Differential', data:DIFF_TYPES, pk:'diff',
            spec: c => c.diff_power !== undefined ? `${Math.round(c.diff_power*100)}% lock` : 'Stock' },
        { key:'compounds', title:'üèÅ Tire Compound', data:TIRE_COMPOUNDS, pk:'tire_compound',
            spec: c => `Grip: ${c.grip_mult.toFixed(2)}` },
    ];

    for (const g of groups) {
        const div = document.createElement('div');
        div.className = 'part-group';
        div.innerHTML = `<h3>${g.title}</h3>`;
        for (const [id, part] of Object.entries(g.data)) {
            const compat = isCompatible(part, chassis);
            const sel = state.selectedParts[g.pk] === id;
            const opt = document.createElement('div');
            opt.className = 'part-option' + (sel ? ' selected' : '') + (!compat ? ' disabled' : '');
            opt.innerHTML = `<div class="part-name">${part.name}</div>
                <div class="part-desc">${part.description||''}</div>
                <div class="part-spec">${g.spec(part)}</div>`;
            if (compat) opt.onclick = () => { state.selectedParts[g.pk] = id; renderCustomParts(); };
            div.appendChild(opt);
        }
        grid.appendChild(div);
    }
}

function generatePhysics() {
    if (state.mode === 'quick' && !state.classKey) { alert('Please select a class first!'); return; }
    state.result = calculatePhysics(state.stock, state.selectedParts);
    renderResults();
    goStep(3);
}

function renderResults() {
    const r = state.result; const sm = r.summary; const c = state.carInfo;
    const partsList = Object.values(sm.parts).filter(v => v !== 'Stock Suspension' && v !== 'Stock Steering' && v !== 'Stock Wheels & Tires' && v !== 'Stock Brakes' && v !== 'Stock Differential' && v !== 'Stock Engine' && v !== 'All-Season / Street');
    document.getElementById('resultBanner').innerHTML = `
        <div>
            <div class="name">${c.name || c.model}${sm.engine !== 'Stock Engine' ? ' ‚Äî '+sm.engine+' Swap' : ''}</div>
            <div class="detail">${partsList.join(' ¬∑ ') || 'Stock configuration'}</div>
        </div>`;

    document.getElementById('summaryGrid').innerHTML = [
        ['Mass', sm.total_mass, 'kg'],
        ['Wt Dist', `${(sm.weight_dist_f*100).toFixed(1)}/${(100-sm.weight_dist_f*100).toFixed(1)}`, 'F/R'],
        ['Nat Freq F', sm.natural_freq_f, 'Hz'],
        ['Nat Freq R', sm.natural_freq_r, 'Hz'],
        ['Max Angle', sm.max_angle, '¬∞'],
        ['Hub F', sm.hub_mass_f, 'kg'],
        ['Hub R', sm.hub_mass_r, 'kg'],
    ].map(([l,v,u]) => `<div class="summary-card"><div class="label">${l}</div><div class="value">${v} <span class="unit">${u}</span></div></div>`).join('');

    const cats = {chassis:'Chassis',suspension:'Suspension',unsprung:'Unsprung Mass',steering:'Steering',tires:'Tires & Wheels',brakes:'Brakes',diff:'Differential'};
    const tables = document.getElementById('comparisonTables');
    tables.innerHTML = '';
    for (const [ck, cn] of Object.entries(cats)) {
        const items = r.comparison.filter(c => c.category === ck);
        if (!items.length) continue;
        const sec = document.createElement('div');
        sec.className = 'comp-section';
        let h = `<h3>${cn}</h3><table><tr><th>Parameter</th><th>Stock</th><th>Modified</th></tr>`;
        for (const it of items) {
            const ch = it.stock !== it.modified;
            h += `<tr><td>${it.param}</td><td class="stock">${it.stock}</td><td class="${ch?'changed':'stock'}">${it.modified}</td></tr>`;
        }
        sec.innerHTML = h + '</table>';
        tables.appendChild(sec);
    }
}

async function downloadZip() {
    const r = state.result;
    const zip = new JSZip();
    const dataFolder = zip.folder('data');

    // Apply changes to raw files
    for (const [fname, content] of Object.entries(state.rawFiles)) {
        let modified = content;
        if (r.changes[fname]) {
            modified = applyChanges(content, r.changes[fname]);
        }
        dataFolder.file(fname, modified);
    }

    // README
    const carName = state.stock.screen_name || 'Unknown';
    let readme = `RealiSimHQ Physics Modifications\n================================\nCar: ${carName}\nMass: ${r.summary.total_mass} kg\n\nSelected Parts:\n`;
    for (const [k,v] of Object.entries(r.summary.parts)) readme += `  ${k}: ${v}\n`;
    readme += `\nPhysics Summary:\n  Natural Freq: ${r.summary.natural_freq_f} / ${r.summary.natural_freq_r} Hz\n  Max Angle: ${r.summary.max_angle}¬∞\n\nInstructions:\n  1. Extract this zip into your AC car's folder\n  2. The data/ folder will overlay the car's physics\n  3. Back up your original data/ folder first!\n`;
    zip.file('README.txt', readme);

    const blob = await zip.generateAsync({type:'blob'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `RealiSimHQ_${carName.replace(/[^a-zA-Z0-9]/g,'_')}_physics.zip`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
