<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RealiSimHQ AC Physics Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root {
    --bg: #08080f; --bg2: #0e0e1a; --bg3: #151525; --bg4: #1c1c35;
    --border: #1a1a35; --border-hi: #00e5ff;
    --cyan: #00e5ff; --cyan-dim: #00e5ff44; --cyan-glow: #00e5ff22; --cyan-bg: #00e5ff08;
    --green: #00ff88; --green-dim: #00ff8844; --red: #ff4466; --orange: #ffaa00; --purple: #aa66ff;
    --text: #e0e0e8; --text2: #8888aa; --text3: #555577;
    --radius: 10px; --radius-lg: 16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Inter','Segoe UI',system-ui,-apple-system,sans-serif;line-height:1.6;min-height:100vh}
.app{max-width:1200px;margin:0 auto;padding:20px 24px}
a{color:var(--cyan);text-decoration:none}

/* Header */
header{text-align:center;padding:32px 0 24px;border-bottom:1px solid var(--border);margin-bottom:28px}
header h1{font-size:2rem;letter-spacing:-1px;font-weight:800}
header h1 .brand{color:var(--cyan);text-shadow:0 0 30px var(--cyan-glow)}
header .tagline{color:var(--text2);margin-top:6px;font-size:.95em}
header .version{display:inline-block;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:2px 12px;font-size:.7em;color:var(--text3);margin-top:8px}

/* Progress */
.progress{display:flex;gap:4px;margin-bottom:28px;padding:0 40px}
.progress-step{flex:1;text-align:center;position:relative}
.progress-step .bar{height:3px;background:var(--border);border-radius:2px;transition:background .4s}
.progress-step.done .bar{background:var(--cyan)}
.progress-step.current .bar{background:linear-gradient(90deg,var(--cyan),var(--cyan-dim))}
.progress-step .label{font-size:.7em;color:var(--text3);margin-top:4px;text-transform:uppercase;letter-spacing:1px}
.progress-step.done .label,.progress-step.current .label{color:var(--text2)}

/* Steps */
.step{display:none;animation:fadeIn .35s ease}
.step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}

/* Drop zone */
.drop-zone{
    border:2px dashed var(--border);border-radius:var(--radius-lg);padding:70px 40px;
    text-align:center;cursor:pointer;transition:all .3s ease;
    background:linear-gradient(160deg,var(--bg2) 0%,var(--bg3) 100%);
    position:relative;overflow:hidden;
}
.drop-zone::before{content:'';position:absolute;inset:0;border-radius:var(--radius-lg);background:radial-gradient(circle at 50% 50%,var(--cyan-glow) 0%,transparent 70%);opacity:0;transition:opacity .3s}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--cyan);box-shadow:0 0 60px var(--cyan-glow)}
.drop-zone:hover::before,.drop-zone.dragover::before{opacity:1}
.drop-zone .dz-icon{font-size:3.5em;margin-bottom:16px;filter:drop-shadow(0 0 24px var(--cyan))}
.drop-zone .dz-title{font-size:1.3em;font-weight:700;color:var(--cyan);position:relative}
.drop-zone .dz-sub{color:var(--text2);margin-top:8px;font-size:.9em;position:relative}
.drop-zone .dz-formats{color:var(--text3);margin-top:20px;font-size:.8em;position:relative;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.drop-zone .dz-formats span{background:var(--bg);padding:3px 10px;border-radius:6px;border:1px solid var(--border);font-family:'JetBrains Mono',monospace}
.drop-zone input{display:none}
.drop-zone.loading .dz-icon{animation:pulse 1.5s ease infinite}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}

/* Car banner */
.car-banner{
    background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--cyan-dim);
    border-radius:var(--radius);padding:18px 24px;margin-bottom:24px;
    display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;
}
.car-banner .cb-name{font-size:1.4em;font-weight:800}
.car-banner .cb-detail{color:var(--text2);font-size:.85em;margin-top:2px}
.car-banner .cb-stats{display:flex;gap:8px;flex-wrap:wrap}
.car-banner .cb-stat{background:var(--bg);padding:5px 12px;border-radius:6px;font-size:.8em;color:var(--text2);border:1px solid var(--border)}
.car-banner .cb-stat b{color:var(--cyan)}

/* Detection card */
.detect-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px}
.detect-card h3{color:var(--cyan);font-size:.9em;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.detect-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.detect-item{background:var(--bg3);border-radius:6px;padding:10px 14px}
.detect-item .di-label{font-size:.7em;text-transform:uppercase;letter-spacing:1px;color:var(--text3)}
.detect-item .di-value{color:var(--text);font-size:1em;font-weight:600;margin-top:2px}
.detect-item .di-value.highlight{color:var(--cyan)}

/* Mode selector */
.mode-select{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
@media(max-width:640px){.mode-select{grid-template-columns:1fr}}
.mode-card{
    background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-lg);
    padding:28px;cursor:pointer;transition:all .2s;text-align:center;position:relative;overflow:hidden;
}
.mode-card::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 30%,var(--cyan-glow),transparent 70%);opacity:0;transition:opacity .3s}
.mode-card:hover{border-color:var(--cyan-dim);transform:translateY(-3px)}
.mode-card:hover::before{opacity:.5}
.mode-card.selected{border-color:var(--cyan);background:var(--cyan-bg)}
.mode-card.selected::before{opacity:1}
.mode-card .mc-icon{font-size:2.5em;margin-bottom:10px;position:relative}
.mode-card .mc-title{font-size:1.15em;font-weight:700;color:var(--cyan);position:relative}
.mode-card .mc-desc{color:var(--text2);font-size:.85em;margin-top:6px;position:relative}

/* Class grid */
.class-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px}
@media(max-width:768px){.class-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}}
.class-card{
    background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius);
    padding:16px;cursor:pointer;transition:all .15s;text-align:center;
}
.class-card:hover{border-color:var(--cyan-dim);transform:translateY(-2px)}
.class-card.selected{border-color:var(--cyan);background:var(--cyan-bg)}
.class-card .cc-icon{font-size:1.6em;margin-bottom:6px}
.class-card .cc-name{font-weight:700;color:var(--cyan);font-size:1em}
.class-card .cc-hp{color:var(--orange);font-size:.8em;margin-top:4px}
.class-card .cc-desc{color:var(--text3);font-size:.75em;margin-top:4px}

/* Section header */
.section-hdr{display:flex;align-items:center;gap:10px;margin:28px 0 16px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.section-hdr h2{font-size:1.1em;color:var(--cyan);font-weight:700}
.section-hdr .sh-badge{background:var(--bg3);color:var(--text3);font-size:.7em;padding:2px 8px;border-radius:10px;border:1px solid var(--border)}

/* Parts grid */
.parts-section{margin-bottom:24px}
.parts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
@media(max-width:700px){.parts-grid{grid-template-columns:1fr}}
.part-group{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;max-height:400px;overflow-y:auto}
.part-group::-webkit-scrollbar{width:4px}
.part-group::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.part-group h3{font-size:.9em;color:var(--cyan);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:8px}
.part-option{
    padding:12px 14px;border:1px solid var(--border);border-radius:8px;
    margin-bottom:8px;cursor:pointer;transition:all .15s;
}
.part-option:last-child{margin-bottom:0}
.part-option:hover{border-color:var(--cyan-dim);background:rgba(0,229,255,.02)}
.part-option.selected{border-color:var(--cyan);background:var(--cyan-bg)}
.part-option.disabled{opacity:.3;pointer-events:none}
.part-option .po-brand{font-size:.65em;text-transform:uppercase;letter-spacing:1px;color:var(--text3)}
.part-option .po-name{font-weight:600;font-size:.95em;margin-top:2px}
.part-option .po-desc{color:var(--text3);font-size:.8em;margin-top:3px}
.part-option .po-spec{color:var(--orange);font-size:.8em;margin-top:3px;font-weight:500}

/* Turbo section */
.turbo-section{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:20px}
.turbo-section h3{font-size:.9em;color:var(--orange);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px}
.turbo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:600px){.turbo-grid{grid-template-columns:1fr 1fr}}
.turbo-card{
    padding:14px;border:1px solid var(--border);border-radius:8px;cursor:pointer;
    text-align:center;transition:all .15s;
}
.turbo-card:hover{border-color:var(--orange);background:rgba(255,170,0,.03)}
.turbo-card.selected{border-color:var(--orange);background:rgba(255,170,0,.08)}
.turbo-card .tc-icon{font-size:1.4em;margin-bottom:4px}
.turbo-card .tc-name{font-weight:600;font-size:.9em}
.turbo-card .tc-spec{color:var(--orange);font-size:.75em;margin-top:4px}
.turbo-card .tc-desc{color:var(--text3);font-size:.7em;margin-top:2px}

/* Drivetrain selector */
.dt-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.dt-card{
    padding:16px;border:2px solid var(--border);border-radius:var(--radius);cursor:pointer;
    text-align:center;transition:all .15s;
}
.dt-card:hover{border-color:var(--purple)}
.dt-card.selected{border-color:var(--purple);background:rgba(170,102,255,.06)}
.dt-card.disabled{opacity:.35;pointer-events:none}
.dt-card .dtc-icon{font-size:1.3em;margin-bottom:4px}
.dt-card .dtc-name{font-weight:700;color:var(--purple)}
.dt-card .dtc-note{font-size:.75em;color:var(--text3);margin-top:2px}

/* Summary */
.summary-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:24px}
.summary-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.summary-card .sc-label{color:var(--text2);font-size:.7em;text-transform:uppercase;letter-spacing:1.5px}
.summary-card .sc-value{color:var(--cyan);font-size:1.5em;font-weight:700;margin-top:4px}
.summary-card .sc-unit{color:var(--text3);font-size:.6em;font-weight:400}
.summary-card .sc-delta{font-size:.7em;margin-top:2px}
.summary-card .sc-delta.up{color:var(--green)}
.summary-card .sc-delta.down{color:var(--red)}
.summary-card .sc-delta.neutral{color:var(--text3)}

/* Comparison */
details.comp-details{margin-bottom:24px}
details.comp-details summary{cursor:pointer;color:var(--cyan);font-weight:600;padding:10px 0;font-size:.95em;user-select:none}
details.comp-details summary:hover{color:var(--text)}
.comp-section{margin-bottom:20px}
.comp-section h3{color:var(--text2);font-size:.8em;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
table{width:100%;border-collapse:collapse}
th{background:var(--bg3);color:var(--text2);padding:8px 12px;text-align:left;font-size:.75em;text-transform:uppercase;letter-spacing:1px}
td{padding:8px 12px;border-bottom:1px solid var(--border);font-size:.85em}
td.stock{color:var(--text3)}
td.changed{color:var(--orange);font-weight:600}

/* Files list */
.files-list{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:20px}
.files-list h3{color:var(--text2);font-size:.8em;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.file-item{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:.85em}
.file-item .fi-icon{color:var(--cyan)}
.file-item .fi-name{font-family:'JetBrains Mono',monospace;font-size:.85em}
.file-item .fi-status{font-size:.7em;padding:2px 8px;border-radius:10px}
.file-item .fi-status.modified{background:rgba(255,170,0,.15);color:var(--orange)}
.file-item .fi-status.added{background:rgba(0,255,136,.15);color:var(--green)}
.file-item .fi-status.copied{background:rgba(136,136,170,.15);color:var(--text2)}

/* Buttons */
.btn{
    background:linear-gradient(135deg,var(--cyan),#00b8d4);color:var(--bg);border:none;
    border-radius:var(--radius);padding:14px 36px;font-size:1em;font-weight:700;
    cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px;
    box-shadow:0 4px 20px rgba(0,229,255,.2);
}
.btn:hover{filter:brightness(1.1);transform:translateY(-2px);box-shadow:0 6px 30px rgba(0,229,255,.3)}
.btn:active{transform:translateY(0)}
.btn-outline{
    background:transparent;border:1px solid var(--border);color:var(--text);
    border-radius:var(--radius);padding:10px 20px;font-size:.9em;cursor:pointer;transition:all .2s;
}
.btn-outline:hover{border-color:var(--cyan);color:var(--cyan)}
.btn-row{display:flex;gap:12px;margin-top:24px;justify-content:center;flex-wrap:wrap}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:14px 20px;color:var(--text);font-size:.9em;z-index:100;opacity:0;transform:translateY(10px);transition:all .3s;pointer-events:none}
.toast.show{opacity:1;transform:none}

/* Footer */
footer{text-align:center;color:var(--text3);font-size:.8em;padding:40px 0 20px;border-top:1px solid var(--border);margin-top:40px}
footer a{color:var(--text2)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}

/* Responsive */
@media(max-width:480px){
    .app{padding:12px 14px}
    header h1{font-size:1.5rem}
    .drop-zone{padding:40px 20px}
}
</style>
</head>
<body>
<div class="app">
    <header>
        <h1>‚ö° <span class="brand">RealiSimHQ</span> Physics Tool</h1>
        <p class="tagline">Drop your car ‚Üí Pick your parts ‚Üí Download real physics</p>
        <span class="version">v4.0 ‚Äî Read & Modify Engine</span>
    </header>

    <div class="progress" id="progress">
        <div class="progress-step current" data-step="1"><div class="bar"></div><div class="label">Upload</div></div>
        <div class="progress-step" data-step="2"><div class="bar"></div><div class="label">Configure</div></div>
        <div class="progress-step" data-step="3"><div class="bar"></div><div class="label">Download</div></div>
    </div>

    <!-- STEP 1 -->
    <div class="step active" id="step1">
        <div class="drop-zone" id="dropZone">
            <div class="dz-icon">üìÅ</div>
            <div class="dz-title">Drop your car's data/ folder here</div>
            <div class="dz-sub">Drag the entire data folder, or select individual files</div>
            <div class="dz-formats">
                <span>car.ini</span><span>suspensions.ini</span><span>drivetrain.ini</span>
                <span>engine.ini</span><span>tyres.ini</span><span>*.lut</span>
            </div>
            <input type="file" id="fileInput" multiple>
            <input type="file" id="folderInput" webkitdirectory multiple>
        </div>
        <p style="text-align:center;color:var(--text3);margin-top:14px;font-size:.85em">
            Path: <code style="color:var(--cyan)">assettocorsa/content/cars/YOUR_CAR/data/</code>
            <br>Click to browse files ¬∑ <strong>Shift+Click</strong> for folder select
        </p>
    </div>

    <!-- STEP 2 -->
    <div class="step" id="step2">
        <div class="car-banner" id="carBanner"></div>
        <div id="detectionCard"></div>
        <div class="mode-select" id="modeSelect">
            <div class="mode-card" data-mode="quick">
                <div class="mc-icon">üöÄ</div>
                <div class="mc-title">Quick Build</div>
                <div class="mc-desc">Pick a class tier ‚Äî Factory, Grassroots, Street, Pro, or Race. Pre-configured part packages.</div>
            </div>
            <div class="mode-card" data-mode="custom">
                <div class="mc-icon">üîß</div>
                <div class="mc-title">Custom Build</div>
                <div class="mc-desc">Choose individual parts, engine swap, turbo, drivetrain layout, and tire compound.</div>
            </div>
        </div>
        <div id="quickBuild" style="display:none"></div>
        <div id="customBuild" style="display:none"></div>
        <div class="btn-row">
            <button class="btn-outline" onclick="goStep(1)">‚Üê Upload Different Car</button>
            <button class="btn" id="generateBtn" onclick="generatePhysics()" style="display:none">‚ö° Generate Physics</button>
        </div>
    </div>

    <!-- STEP 3 -->
    <div class="step" id="step3">
        <div class="car-banner" id="resultBanner"></div>
        <div class="summary-grid" id="summaryGrid"></div>
        <div id="filesList"></div>
        <details class="comp-details">
            <summary>üìä Detailed Before / After Comparison</summary>
            <div id="comparisonTables"></div>
        </details>
        <div class="btn-row">
            <button class="btn-outline" onclick="goStep(2)">‚Üê Modify Parts</button>
            <button class="btn" onclick="downloadZip()">üì¶ Download Modified Physics</button>
        </div>
    </div>

    <footer>RealiSimHQ ¬© 2025 ‚Äî Real parts, real physics. <a href="https://github.com/realisimhq" target="_blank">GitHub</a></footer>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INI PARSER ‚Äî handles AC physics files robustly
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseIni(text) {
    const sections = {};
    let cur = null;
    for (const raw of text.split('\n')) {
        const line = raw.replace(/;.*$/, '').trim();
        if (!line || line.startsWith('#') || line.startsWith('//')) continue;
        const sm = line.match(/^\[(.+?)\]$/);
        if (sm) { cur = sm[1]; if (!sections[cur]) sections[cur] = {}; continue; }
        if (!cur) continue;
        const eq = line.indexOf('=');
        if (eq < 1) continue;
        const key = line.substring(0, eq).trim();
        let val = line.substring(eq + 1).trim();
        const f = parseFloat(val);
        sections[cur][key] = isNaN(f) ? val : (val.includes('.') || val.includes('e') || val.includes('E') ? f : (Number.isInteger(f) ? parseInt(val, 10) : f));
    }
    return sections;
}

function getVal(sections, section, key, def) {
    return sections?.[section]?.[key] ?? def;
}

function parseLut(text) {
    const entries = [];
    for (const line of text.split('\n')) {
        const t = line.replace(/;.*$/, '').trim();
        if (!t) continue;
        const sep = t.includes('|') ? '|' : /\s+/;
        const parts = t.split(sep);
        if (parts.length >= 2) {
            const x = parseFloat(parts[0]);
            const y = parseFloat(parts[parts.length - 1]);
            if (!isNaN(x) && !isNaN(y)) entries.push([x, y]);
        }
    }
    return entries;
}

function lutToString(entries) {
    return entries.map(([x, y]) => `${x}|${y}`).join('\n');
}

function applyIniChanges(content, sectionChanges) {
    let result = content;
    for (const [section, vals] of Object.entries(sectionChanges)) {
        for (const [key, newVal] of Object.entries(vals)) {
            // Try to replace existing key=value in the right section
            const escapedKey = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const pat = new RegExp(`(\\[${section.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\][^\\[]*?\\n\\s*)${escapedKey}\\s*=\\s*[^\\n]*`, 'i');
            if (pat.test(result)) {
                result = result.replace(pat, `$1${key}=${newVal}`);
            } else {
                // Simpler: just find key= anywhere after the section header
                const lines = result.split('\n');
                let inSection = false;
                let replaced = false;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].trim().match(new RegExp(`^\\[${section.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]$`, 'i'))) {
                        inSection = true; continue;
                    }
                    if (inSection && lines[i].trim().match(/^\[/)) { inSection = false; }
                    if (inSection) {
                        const km = lines[i].match(new RegExp(`^(\\s*)${escapedKey}\\s*=`, 'i'));
                        if (km) {
                            lines[i] = `${km[1]}${key}=${newVal}`;
                            replaced = true; break;
                        }
                    }
                }
                if (replaced) { result = lines.join('\n'); }
                else {
                    // Append to section
                    const secPat = new RegExp(`(\\[${section.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\][^\\[]*)`, 'i');
                    result = result.replace(secPat, (m) => m.trimEnd() + `\n${key}=${newVal}\n`);
                }
            }
        }
    }
    return result;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CHASSIS_CODES = {
    's13':['Nissan','240SX / Silvia (S13)','1989-1994'],
    's14':['Nissan','Silvia (S14)','1994-1998'],
    's15':['Nissan','Silvia (S15)','1999-2002'],
    '180sx':['Nissan','180SX','1989-1998'],
    'e46':['BMW','3 Series / M3 (E46)','1999-2006'],
    'e36':['BMW','M3 (E36)','1992-1999'],
    'ae86':['Toyota','AE86 Corolla','1983-1987'],
    'jza80':['Toyota','Supra (A80)','1993-2002'],
    'a80':['Toyota','Supra (A80)','1993-2002'],
    'fd3s':['Mazda','RX-7 (FD3S)','1992-2002'],
    'ap1':['Honda','S2000 (AP1)','1999-2003'],
    'ap2':['Honda','S2000 (AP2)','2004-2009'],
    'z33':['Nissan','350Z (Z33)','2002-2009'],
    'z34':['Nissan','370Z (Z34)','2009-2020'],
    'r34':['Nissan','Skyline GT-R (R34)','1999-2002'],
    'r33':['Nissan','Skyline GT-R (R33)','1995-1998'],
    'r32':['Nissan','Skyline GT-R (R32)','1989-1994'],
    'c6':['Chevrolet','Corvette (C6)','2005-2013'],
    'c5':['Chevrolet','Corvette (C5)','1997-2004'],
    'gdb':['Subaru','WRX STI (GDB)','2001-2007'],
    'gc8':['Subaru','WRX (GC8)','1992-2000'],
    'ct9a':['Mitsubishi','Lancer Evo IX','2005-2007'],
};

const PLATFORM = {
    s_chassis:['s13','s14','s15','180sx'],
    e46:['e46'], e36:['e36'], ae86:['ae86'],
    jza80:['jza80','a80'], fd3s:['fd3s'],
    s2000:['ap1','ap2'], z33:['z33'], z34:['z34'],
    skyline_r:['r32','r33','r34'],
    c6:['c6'], c5:['c5'], gdb:['gdb'], gc8:['gc8'], evo:['ct9a'],
};

// Suspension type classification from COSMIC body names
function classifySuspType(susText, axle) {
    const t = (susText || '').toUpperCase();
    const prefix = axle === 'front' ? 'FRONT' : 'REAR';
    
    // Check TYPE first
    const typeMatch = t.match(new RegExp(`\\[${prefix}\\][^\\[]*?TYPE\\s*=\\s*(\\w+)`, 'i'));
    const type = typeMatch ? typeMatch[1].toUpperCase() : '';
    
    if (type === 'COSMIC') {
        // Classify COSMIC by body/joint naming
        if (/AXLE/i.test(t) && axle === 'rear') return 'COSMIC_AXLE';
        if (/UCA.*BODY|LCA.*BODY|DWB/i.test(t) && (axle === 'front' ? /\[FRONT\]/i.test(t.split(/\[REAR\]/i)[0] || '') : true)) return 'COSMIC_DWB';
        if (/STRUT/i.test(t)) return 'COSMIC_STRUT';
        if (/HA3|MULTI.*LINK/i.test(t)) return 'COSMIC_ML';
        // Check for DWB indicators: J0 + J1 + J2 pattern (ball joints connecting bodies)
        if (/J0=.*BJ|J2=.*BJ/i.test(t)) return 'COSMIC_DWB';
        return 'COSMIC_STRUT'; // default COSMIC
    }
    if (type === 'DWB') return 'DWB';
    if (type === 'STRUT') return 'STRUT';
    if (type === 'ML') return 'ML';
    if (type === 'AXLE') return 'AXLE';
    return type || 'UNKNOWN';
}

// Better: parse the suspensions text for front and rear sections separately
function detectSuspensionTypes(rawSusText) {
    if (!rawSusText) return { front: 'UNKNOWN', rear: 'UNKNOWN' };
    
    const parsed = parseIni(rawSusText);
    const frontType = getVal(parsed, 'FRONT', 'TYPE', 'STRUT');
    const rearType = getVal(parsed, 'REAR', 'TYPE', 'STRUT');
    
    const result = { front: frontType, rear: rearType };
    
    if (frontType === 'COSMIC') {
        // Look at body names to classify
        const beforeRear = rawSusText.split(/\[REAR\]/i)[0] || rawSusText;
        if (/UCA|LCA.*BODY/i.test(beforeRear) && /J\d+=.*BJ/i.test(beforeRear)) result.front = 'COSMIC_DWB';
        else if (/STRUT/i.test(beforeRear)) result.front = 'COSMIC_STRUT';
        else result.front = 'COSMIC_STRUT';
    }
    
    if (rearType === 'COSMIC') {
        const afterRear = rawSusText.split(/\[REAR\]/i).slice(1).join('') || '';
        if (/AXLE/i.test(afterRear)) result.rear = 'COSMIC_AXLE';
        else if (/HA3|ELASTIC/i.test(afterRear)) result.rear = 'COSMIC_ML';
        else if (/UCA|LCA.*BODY/i.test(afterRear) && /J\d+=.*BJ/i.test(afterRear)) result.rear = 'COSMIC_DWB';
        else if (/SUBFRAME/i.test(afterRear)) result.rear = 'COSMIC_ML';
        else result.rear = 'COSMIC_ML';
    }
    
    return result;
}

function isDWBFront(type) {
    return type === 'DWB' || type === 'COSMIC_DWB';
}

function isAxleRear(type) {
    return type === 'AXLE' || type === 'COSMIC_AXLE';
}

function isStrutFront(type) {
    return type === 'STRUT' || type === 'COSMIC_STRUT';
}

// Get friendly name for suspension type
function suspTypeName(type) {
    const names = {
        'STRUT': 'MacPherson Strut', 'DWB': 'Double Wishbone',
        'ML': 'Multi-Link', 'AXLE': 'Solid Axle',
        'COSMIC_STRUT': 'COSMIC Strut', 'COSMIC_DWB': 'COSMIC Double Wishbone',
        'COSMIC_ML': 'COSMIC Multi-Link', 'COSMIC_AXLE': 'COSMIC Live Axle',
        'UNKNOWN': 'Unknown',
    };
    return names[type] || type;
}

// ‚îÄ‚îÄ ENGINE SWAPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ENGINE_SWAPS = [
    { id:'stock', name:'Stock Engine', brand:'OEM', desc:'Keep original engine', weight_kg:0, hp:0, power_mult:1.0, wt_shift:0, compatible:'all' },
    { id:'sr20det', name:'SR20DET', brand:'Nissan', desc:'2.0L Turbo I4 ‚Äî 205hp stock', weight_kg:180, hp:205, power_mult:1.0, wt_shift:0, compatible:'all' },
    { id:'k20a', name:'K20A', brand:'Honda', desc:'2.0L VTEC I4 ‚Äî 220hp NA, lightweight', weight_kg:130, hp:220, power_mult:1.0, wt_shift:-0.02, compatible:'all' },
    { id:'f20c', name:'F20C', brand:'Honda', desc:'2.0L VTEC I4 ‚Äî 237hp, 8900rpm redline', weight_kg:150, hp:237, power_mult:1.0, wt_shift:-0.015, compatible:'all' },
    { id:'rb25det', name:'RB25DET', brand:'Nissan', desc:'2.5L Turbo I6 ‚Äî 250hp, budget RB', weight_kg:230, hp:250, power_mult:1.0, wt_shift:0.015, compatible:'all' },
    { id:'4g63t', name:'4G63T', brand:'Mitsubishi', desc:'2.0L Turbo I4 ‚Äî 276hp, Evo motor', weight_kg:190, hp:276, power_mult:1.0, wt_shift:0, compatible:'all' },
    { id:'rb26dett', name:'RB26DETT', brand:'Nissan', desc:'2.6L Twin-Turbo I6 ‚Äî 276hp stock', weight_kg:250, hp:276, power_mult:1.0, wt_shift:0.02, compatible:'all' },
    { id:'2jz_gte', name:'2JZ-GTE', brand:'Toyota', desc:'3.0L Twin-Turbo I6 ‚Äî 276hp stock, legendary', weight_kg:265, hp:276, power_mult:1.0, wt_shift:0.025, compatible:'all' },
    { id:'vq35de', name:'VQ35DE', brand:'Nissan', desc:'3.5L V6 NA ‚Äî 287hp, torquey', weight_kg:200, hp:287, power_mult:1.0, wt_shift:0.01, compatible:'all' },
    { id:'ls1', name:'LS1 5.7L V8', brand:'GM', desc:'5.7L V8 ‚Äî 350hp, compact aluminum', weight_kg:210, hp:350, power_mult:1.0, wt_shift:-0.01, compatible:'all' },
    { id:'ls3', name:'LS3 6.2L V8', brand:'GM', desc:'6.2L V8 ‚Äî 430hp, modern swap king', weight_kg:215, hp:430, power_mult:1.0, wt_shift:-0.01, compatible:'all' },
];

// ‚îÄ‚îÄ TURBO SIZES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TURBO_SIZES = [
    { id:'none', name:'No Turbo', icon:'‚ùå', desc:'Naturally aspirated', max_boost:0, wastegate:0, lag_up:0, lag_dn:0, reference:0, gamma:0, power_mult:1.0, spec:'' },
    { id:'small', name:'Small Turbo', icon:'üåÄ', desc:'TD04 / GT25 class', max_boost:0.9, wastegate:0.7, lag_up:0.992, lag_dn:0.975, reference:4500, gamma:2.2, power_mult:1.5, spec:'Up to ~300hp, fast spool' },
    { id:'medium', name:'Medium Turbo', icon:'üåÄ', desc:'GT28 / GT30 class', max_boost:1.35, wastegate:1.0, lag_up:0.988, lag_dn:0.965, reference:5500, gamma:2.0, power_mult:2.0, spec:'Up to ~450hp, mid spool' },
    { id:'large', name:'Large Turbo', icon:'üåÄ', desc:'GT35 / GT40 class', max_boost:1.8, wastegate:1.3, lag_up:0.982, lag_dn:0.955, reference:6500, gamma:1.8, power_mult:2.8, spec:'Up to ~700hp+, slow spool' },
];

// ‚îÄ‚îÄ COILOVERS (ordered lowest to highest) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COILOVERS = [
    { id:'stock', name:'Stock Suspension', brand:'OEM', desc:'Factory springs and shocks', spring_f:0, spring_r:0, quality:'basic', compatible:'all' },
    { id:'tein_flex_z', name:'Flex Z', brand:'Tein', desc:'16-way adjustable, steel body', spring_f:39240, spring_r:29430, quality:'adjustable', compatible:'all' },
    { id:'bc_br', name:'BR Series', brand:'BC Racing', desc:'30-way damping, entry-level coilover', spring_f:44100, spring_r:33075, quality:'adjustable', compatible:'all' },
    { id:'bilstein_b16', name:'B16 PSS10', brand:'Bilstein', desc:'10-way adjustable monotube', spring_f:44100, spring_r:34300, quality:'adjustable', compatible:['e46','e36','c6','c5','z33','ap1','ap2'] },
    { id:'ksport', name:'Kontrol Pro', brand:'KSport', desc:'36-way adjustable, pillow ball mounts', spring_f:49050, spring_r:39240, quality:'adjustable', compatible:'all' },
    { id:'tein_mono', name:'Mono Sport', brand:'Tein', desc:'16-way monotube, advanced valving', spring_f:53955, spring_r:44100, quality:'advanced', compatible:['s13','s14','s15','180sx','z33','r32','r33','r34','jza80','a80','ct9a','gdb','ap1','ap2','fd3s'] },
    { id:'kw_v3', name:'Variant 3', brand:'KW', desc:'Separate rebound/compression, inox-line', spring_f:53955, spring_r:44100, quality:'advanced', compatible:['e46','e36','c6','c5','z33','ap1','ap2','jza80','a80','r32','r33','r34'] },
    { id:'ohlins_rt', name:'Road & Track', brand:'√ñhlins', desc:'DFV technology, 20-way adjustable', spring_f:58860, spring_r:49050, quality:'advanced', compatible:'all' },
    { id:'fortune_500', name:'500 Series', brand:'Fortune Auto', desc:'24-way, Swift springs, digressive', spring_f:58860, spring_r:49050, quality:'advanced', compatible:['s13','s14','s15','180sx','e46','z33','ap1','ap2','fd3s','jza80','a80','ae86'] },
    { id:'mca_blue', name:'Blue Series', brand:'MCA Suspension', desc:'2-way adjustable, race-spec valving', spring_f:68670, spring_r:58860, quality:'advanced', compatible:['s13','s14','s15','180sx','e46','ae86','z33','r32','r33','r34','fd3s','jza80','a80','ap1','ap2'] },
    { id:'bc_zr', name:'ZR Series', brand:'BC Racing', desc:'3-way adjustable, remote reservoir', spring_f:78480, spring_r:68670, quality:'race', compatible:'all' },
];

// ‚îÄ‚îÄ ANGLE KITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ANGLE_KITS = [
    { id:'stock', name:'Stock Steering', brand:'OEM', desc:'Factory steering geometry', angle:0, hub_add:0, compatible:'all' },
    { id:'megan', name:'Angle Kit', brand:'Megan Racing', desc:'Tie rod + lower arm spacer', angle:50, hub_add:1.0, compatible:['s13','s14','s15','180sx','z33','ae86'] },
    { id:'gktech', name:'Steering Angle Kit', brand:'GKTech', desc:'CNC tie rod ends + spacers, bolt-on', angle:55, hub_add:1.2, compatible:['s13','s14','s15','180sx','z33','r32','r33','r34'] },
    { id:'drift_knuckles', name:'Drift Knuckles', brand:'Various', desc:'Extended LCA + modified knuckle', angle:55, hub_add:1.5, compatible:'all' },
    { id:'wisefab', name:'Lock Kit', brand:'Wisefab', desc:'Full kit ‚Äî new knuckles, extended LCA, tie rods', angle:70, hub_add:2.5, compatible:['s13','s14','s15','180sx','e46','z33','r32','r33','r34','jza80','a80','fd3s'] },
];

// ‚îÄ‚îÄ BRAKE KITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BRAKE_KITS = [
    { id:'stock', name:'Stock Brakes', brand:'OEM', desc:'Factory brake system', torque_mult:1.0, bias:0, mass_add:0, compatible:'all' },
    { id:'z32_swap', name:'Z32 4-Pot Caliper', brand:'Nissan OEM', desc:'300ZX front caliper upgrade', torque_mult:1.30, bias:0.64, mass_add:3.0, compatible:['s13','s14','s15','180sx','ae86','z33'] },
    { id:'wilwood', name:'Dynapro 4-Piston', brand:'Wilwood', desc:'Lightweight 4-piston forged caliper', torque_mult:1.40, bias:0.64, mass_add:1.5, compatible:'all' },
    { id:'r33_brembo', name:'R33 GTR Brembo', brand:'Nissan/Brembo OEM', desc:'4-pot Brembo from R33 GT-R', torque_mult:1.45, bias:0.64, mass_add:3.5, compatible:['s13','s14','s15','180sx','r32','r33','r34','z33'] },
    { id:'ap_5200', name:'CP5200 4-Piston', brand:'AP Racing', desc:'Pro-level endurance caliper', torque_mult:1.55, bias:0.65, mass_add:2.0, compatible:'all' },
    { id:'stoptech', name:'Trophy Race', brand:'StopTech', desc:'Asymmetric 4-piston, 355mm rotor', torque_mult:1.60, bias:0.65, mass_add:2.5, compatible:'all' },
    { id:'brembo_gt', name:'GT 6-Piston', brand:'Brembo', desc:'6-piston monobloc, 380mm rotor', torque_mult:1.80, bias:0.66, mass_add:4.0, compatible:'all' },
];

// ‚îÄ‚îÄ DIFFERENTIALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DIFFS = [
    { id:'stock', name:'Stock Differential', brand:'OEM', desc:'Factory differential', power:null, coast:null, preload:null, compatible:'all' },
    { id:'cusco_rs', name:'RS 1.5-Way', brand:'Cusco', desc:'1.5-way clutch, street/track', power:0.65, coast:0.30, preload:50, compatible:'all' },
    { id:'wavetrac', name:'ATB LSD', brand:'Wavetrac', desc:'Gear-type, progressive on decel', power:0.45, coast:0.35, preload:25, compatible:['e46','e36','c6','c5','ap1','ap2','z33','gdb','ct9a'] },
    { id:'kaaz_15', name:'1.5-Way LSD', brand:'Kaaz', desc:'Strong power lock, mild coast', power:0.75, coast:0.35, preload:60, compatible:'all' },
    { id:'os_giken', name:'Super Lock', brand:'OS Giken', desc:'Multi-plate, progressive lockup', power:0.85, coast:0.45, preload:70, compatible:['s13','s14','s15','180sx','r32','r33','r34','jza80','a80','z33','fd3s','ae86','ap1','ap2'] },
    { id:'drexler', name:'Motorsport LSD', brand:'Drexler', desc:'Preload-adjustable, race-grade', power:0.80, coast:0.50, preload:75, compatible:['e46','c6','jza80','a80','fd3s','ap1','ap2','r32','r33','r34'] },
    { id:'kaaz_2way', name:'2-Way LSD', brand:'Kaaz', desc:'Full 2-way, drift spec', power:0.90, coast:0.55, preload:80, compatible:'all' },
    { id:'cusco_mz', name:'Type MZ 2-Way', brand:'Cusco', desc:'Full 2-way, competition drift', power:0.95, coast:0.60, preload:90, compatible:'all' },
    { id:'welded', name:'Welded / Spool', brand:'N/A', desc:'Fully locked (welded or mini spool)', power:1.0, coast:1.0, preload:200, compatible:'all' },
];

// ‚îÄ‚îÄ TIRE COMPOUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COMPOUNDS = [
    { id:'street', name:'All-Season / Street', grip:1.10, dx:1.28, dy:1.28 },
    { id:'200tw', name:'200TW (RS4 / Federal 595)', grip:1.25, dx:1.35, dy:1.35 },
    { id:'semi_slick', name:'Semi-Slick (RE-71RS / AD09)', grip:1.38, dx:1.44, dy:1.44 },
    { id:'slick', name:'Racing Slick (Hoosier / NT01)', grip:1.50, dx:1.55, dy:1.55 },
];

// ‚îÄ‚îÄ CLASS PRESETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CLASS_PRESETS = [
    { id:'factory', icon:'üè≠', label:'Factory', hp:'Stock HP', desc:'OEM feel, no modifications',
        coilovers:'stock', angle_kit:'stock', brakes:'stock', diff:'stock', compound:'street', engine:'stock', turbo:'none', drivetrain:null },
    { id:'grassroots', icon:'üî∞', label:'Grassroots', hp:'200-350hp', desc:'Budget weekend warrior',
        coilovers:'bc_br', angle_kit:'megan', brakes:'z32_swap', diff:'cusco_rs', compound:'200tw', engine:'stock', turbo:'none', drivetrain:null },
    { id:'street', icon:'üèéÔ∏è', label:'Street', hp:'300-500hp', desc:'Serious street build',
        coilovers:'ohlins_rt', angle_kit:'wisefab', brakes:'wilwood', diff:'kaaz_15', compound:'semi_slick', engine:'stock', turbo:'small', drivetrain:null },
    { id:'pro', icon:'üèÜ', label:'Pro', hp:'500-800hp', desc:'Formula Drift / Pro-Am spec',
        coilovers:'mca_blue', angle_kit:'wisefab', brakes:'ap_5200', diff:'kaaz_2way', compound:'semi_slick', engine:'stock', turbo:'large', drivetrain:null },
    { id:'race', icon:'üèÅ', label:'Race', hp:'350-600hp', desc:'Time attack / endurance',
        coilovers:'bc_zr', angle_kit:'stock', brakes:'brembo_gt', diff:'os_giken', compound:'slick', engine:'stock', turbo:'medium', drivetrain:null },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
    step: 1,
    rawFiles: {},       // filename ‚Üí raw text
    parsed: {},         // filename ‚Üí parsed sections (for .ini)
    lutFiles: {},       // filename ‚Üí raw text (for .lut)
    stock: {},          // extracted stock values
    carInfo: {},
    suspTypes: { front: 'UNKNOWN', rear: 'UNKNOWN' },
    detectedChassis: null,
    hasExistingTurbo: false,
    existingTurbo: null,
    mode: null,
    classKey: null,
    sel: {
        coilovers: 'stock', angle_kit: 'stock', brakes: 'stock', diff: 'stock',
        compound: 'street', engine: 'stock', turbo: 'none', drivetrain: null,
    },
    result: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAR DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detectCar() {
    const car = S.parsed['car.ini'] || {};
    const susp = S.parsed['suspensions.ini'] || {};
    const dt = S.parsed['drivetrain.ini'] || {};
    const eng = S.parsed['engine.ini'] || {};
    const tyres = S.parsed['tyres.ini'] || {};
    const brakes = S.parsed['brakes.ini'] || {};

    const screenName = getVal(car, 'INFO', 'SCREEN_NAME', '') || getVal(car, 'HEADER', 'SCREEN_NAME', '');
    const shortName = getVal(car, 'INFO', 'SHORT_NAME', '');

    // Detect chassis code
    let chassis = null, make = 'Unknown', model = screenName || shortName || 'Unknown Car', year = '';
    const nameLC = (screenName + ' ' + shortName + ' ' + (S.rawFiles['car.ini'] || '')).toLowerCase().replace(/[-_\s]/g, '');
    for (const [code, info] of Object.entries(CHASSIS_CODES)) {
        if (nameLC.includes(code.replace(/[-_\s]/g, ''))) {
            chassis = code; make = info[0]; model = info[1]; year = info[2]; break;
        }
    }

    // Detect suspension types from raw text
    S.suspTypes = detectSuspensionTypes(S.rawFiles['suspensions.ini'] || '');

    // Detect existing turbo
    S.hasExistingTurbo = !!(eng['TURBO_0']);
    if (S.hasExistingTurbo) {
        S.existingTurbo = {
            max_boost: getVal(eng, 'TURBO_0', 'MAX_BOOST', 0),
            wastegate: getVal(eng, 'TURBO_0', 'WASTEGATE', 0),
            lag_up: getVal(eng, 'TURBO_0', 'LAG_UP', 0.99),
            lag_dn: getVal(eng, 'TURBO_0', 'LAG_DN', 0.97),
            reference: getVal(eng, 'TURBO_0', 'REFERENCE', 5000),
            gamma: getVal(eng, 'TURBO_0', 'GAMMA', 2.0),
        };
    }

    // Detect LSRR for steering modification capability
    const lsrr = getVal(car, 'CONTROLS', 'LINEAR_STEER_ROD_RATIO', 0);
    const hasRackLut = !!(getVal(car, 'CONTROLS', 'RACK_TRAVEL_LUT', ''));

    // Read spring rates ‚Äî handle COSMIC coilover vs standard
    let springF = getVal(susp, 'FRONT', 'SPRING_RATE', 0);
    let springR = getVal(susp, 'REAR', 'SPRING_RATE', 0);
    // For COSMIC, look at FRONT_COILOVER_0 RATE
    if (springF === 0) springF = getVal(susp, 'FRONT_COILOVER_0', 'RATE', 30000);
    if (springR === 0) springR = getVal(susp, 'REAR_COILOVER_0', 'RATE', 25000);

    // Read power curve to estimate HP
    let peakHP = 0;
    const powerCurve = getVal(eng, 'HEADER', 'POWER_CURVE', 'power.lut');
    if (S.lutFiles[powerCurve]) {
        const lut = parseLut(S.lutFiles[powerCurve]);
        for (const [rpm, torque] of lut) {
            const hp = torque * rpm / 5252 * 1.34102; // wheel Nm * rpm ‚Üí hp
            // Actually AC power.lut is RPM|Torque(Nm) at wheels, so:
            const hpCalc = (torque * rpm) / 7120.9; // Nm*RPM / 7120.9 = kW ‚Üí *1.341 = hp
            // Simpler: hp = torque_Nm * rpm / 7023
            const hpSimple = torque * rpm / 7023;
            if (hpSimple > peakHP) peakHP = Math.round(hpSimple);
        }
    }

    const stock = {
        screen_name: screenName || shortName || model,
        total_mass: getVal(car, 'BASIC', 'TOTALMASS', 1300),
        steer_lock: getVal(car, 'CONTROLS', 'STEER_LOCK', 450),
        steer_ratio: getVal(car, 'CONTROLS', 'STEER_RATIO', 16),
        lsrr: lsrr,
        has_rack_lut: hasRackLut,
        rack_lut_name: getVal(car, 'CONTROLS', 'RACK_TRAVEL_LUT', ''),
        ffmult: getVal(car, 'CONTROLS', 'FFMULT', 1.5),
        wheelbase: getVal(susp, 'BASIC', 'WHEELBASE', 2.5),
        cg_location: getVal(susp, 'BASIC', 'CG_LOCATION', 0.55),
        spring_rate_f: springF,
        spring_rate_r: springR,
        hub_mass_f: getVal(susp, 'FRONT', 'HUB_MASS', 35),
        hub_mass_r: getVal(susp, 'REAR', 'HUB_MASS', 30),
        track_f: getVal(susp, 'FRONT', 'TRACK', 1.48),
        track_r: getVal(susp, 'REAR', 'TRACK', 1.48),
        arb_f: getVal(susp, 'ARB', 'FRONT', 20000),
        arb_r: getVal(susp, 'ARB', 'REAR', 10000),
        tire_width_f: getVal(tyres, 'FRONT', 'WIDTH', 0.225),
        tire_width_r: getVal(tyres, 'REAR', 'WIDTH', 0.225),
        tire_radius_f: getVal(tyres, 'FRONT', 'RADIUS', 0.31),
        tire_radius_r: getVal(tyres, 'REAR', 'RADIUS', 0.31),
        brake_torque: getVal(brakes, 'DATA', 'MAX_TORQUE', 2000),
        brake_bias: getVal(brakes, 'DATA', 'FRONT_SHARE', 0.62),
        drivetrain_type: getVal(dt, 'TRACTION', 'TYPE', 'RWD'),
        diff_power: getVal(dt, 'DIFFERENTIAL', 'POWER', 0.0),
        diff_coast: getVal(dt, 'DIFFERENTIAL', 'COAST', 0.0),
        diff_preload: getVal(dt, 'DIFFERENTIAL', 'PRELOAD', 0),
        gear_count: getVal(dt, 'GEARS', 'COUNT', 5),
        final_ratio: getVal(dt, 'GEARS', 'FINAL', 3.7),
        peak_hp: peakHP,
        susp_type_f: S.suspTypes.front,
        susp_type_r: S.suspTypes.rear,
    };

    // Derived
    stock.weight_dist_f = stock.cg_location > 0 ? stock.cg_location : 0.55;
    const sprungTotal = stock.total_mass - (stock.hub_mass_f * 2 + stock.hub_mass_r * 2);
    stock.sprung_f = Math.round(sprungTotal * stock.weight_dist_f / 2 * 10) / 10;
    stock.sprung_r = Math.round(sprungTotal * (1 - stock.weight_dist_f) / 2 * 10) / 10;
    stock.max_angle = stock.steer_ratio > 0 ? Math.round(stock.steer_lock / stock.steer_ratio * 10) / 10 : 35;
    const fn = (k, m) => m > 0 && k > 0 ? Math.round((1/(2*Math.PI)) * Math.sqrt(k/m) * 100) / 100 : 0;
    stock.freq_f = fn(stock.spring_rate_f, stock.sprung_f);
    stock.freq_r = fn(stock.spring_rate_r, stock.sprung_r);

    S.stock = stock;
    S.carInfo = { chassis, make, model, year, name: screenName || model };
    S.detectedChassis = chassis;
    
    // Set initial drivetrain to match detected
    S.sel.drivetrain = stock.drivetrain_type;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPATIBILITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isCompat(compatList, chassis) {
    if (!compatList || compatList === 'all') return true;
    if (!chassis) return true;
    return compatList.includes(chassis);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHYSICS CALCULATION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calculatePhysics() {
    const stock = S.stock;
    const sel = S.sel;
    
    const coilover = COILOVERS.find(c => c.id === sel.coilovers) || COILOVERS[0];
    const angleKit = ANGLE_KITS.find(a => a.id === sel.angle_kit) || ANGLE_KITS[0];
    const brakeKit = BRAKE_KITS.find(b => b.id === sel.brakes) || BRAKE_KITS[0];
    const diff = DIFFS.find(d => d.id === sel.diff) || DIFFS[0];
    const compound = COMPOUNDS.find(c => c.id === sel.compound) || COMPOUNDS[0];
    const engine = ENGINE_SWAPS.find(e => e.id === sel.engine) || ENGINE_SWAPS[0];
    const turbo = TURBO_SIZES.find(t => t.id === sel.turbo) || TURBO_SIZES[0];

    let totalMass = stock.total_mass;
    let wdf = stock.weight_dist_f;
    let steerLock = stock.steer_lock;
    let steerRatio = stock.steer_ratio;
    let lsrr = stock.lsrr;

    // Engine swap ‚Äî weight delta
    // Estimate original engine weight from car mass (rough: ~15-20% of total)
    if (sel.engine !== 'stock' && engine.weight_kg > 0) {
        const estOrigWeight = Math.round(stock.total_mass * 0.15); // rough estimate
        const delta = engine.weight_kg - estOrigWeight;
        totalMass += delta;
        wdf += engine.wt_shift;
        wdf = Math.max(0.38, Math.min(0.65, wdf));
    }

    // Drivetrain swap
    const dtChanged = sel.drivetrain && sel.drivetrain !== stock.drivetrain_type;
    if (dtChanged) {
        if (sel.drivetrain === 'RWD' && stock.drivetrain_type === 'FWD') {
            totalMass += 30; // trans tunnel, driveshaft, diff weight
            wdf -= 0.05; // moves weight rearward
        } else if (sel.drivetrain === 'AWD') {
            totalMass += 50; // transfer case, front diff, driveshafts
            wdf = Math.max(0.45, wdf - 0.02);
        }
    }

    // Springs
    let springF = stock.spring_rate_f, springR = stock.spring_rate_r;
    if (coilover.spring_f > 0) { springF = coilover.spring_f; springR = coilover.spring_r; }

    // Hub mass
    const hubF = stock.hub_mass_f + (brakeKit.mass_add || 0) + (angleKit.hub_add || 0);
    const hubR = stock.hub_mass_r;

    const sprungTotal = totalMass - (hubF * 2 + hubR * 2);
    const sprungF = sprungTotal * wdf / 2;
    const sprungR = sprungTotal * (1 - wdf) / 2;
    const fn = (k, m) => m > 0 && k > 0 ? Math.round((1/(2*Math.PI)) * Math.sqrt(k/m) * 100) / 100 : 0;

    // Damping
    const dqMap = { basic: [0.22, 0.35], adjustable: [0.25, 0.40], advanced: [0.28, 0.45], race: [0.30, 0.48] };
    const [bRatio, rRatio] = dqMap[coilover.quality] || dqMap.adjustable;
    const calcDamp = (k, m, br, rr) => {
        const cc = 2 * Math.sqrt(k * m);
        return { bump: Math.round(cc * br), rebound: Math.round(cc * rr), fast_bump: Math.round(cc * br * 0.5), fast_rebound: Math.round(cc * rr * 0.5) };
    };
    const dampF = calcDamp(springF, sprungF, bRatio, rRatio);
    const dampR = calcDamp(springR, sprungR, bRatio, rRatio);

    // ARB ‚Äî scale proportionally to spring rate change
    const arbF = stock.spring_rate_f > 0 ? Math.round(stock.arb_f * springF / stock.spring_rate_f) : stock.arb_f;
    const arbR = stock.spring_rate_r > 0 ? Math.round(stock.arb_r * springR / stock.spring_rate_r) : stock.arb_r;

    // Steering ‚Äî angle kit
    // Angle kits achieve more angle through GEOMETRY changes (new knuckles, extended LCA, tie rods)
    // They do NOT change steer_lock dramatically. The kit gives the wheels more room to turn.
    // We increase steer_lock modestly to allow the full range, but the geometry does the real work.
    // Formula: if stock gives X degrees at wheels, and kit allows Y degrees,
    // we need steer_lock that lets the rack travel far enough for Y degrees.
    // Scale steer_lock proportionally to the angle increase.
    let maxAngle = stock.max_angle;
    if (angleKit.angle > 0 && stock.max_angle > 0) {
        maxAngle = angleKit.angle;
        const angleRatio = angleKit.angle / stock.max_angle;
        steerLock = Math.round(stock.steer_lock * angleRatio);
    }

    // Steering ratio change (DWB front only) ‚Äî for now, keep stock ratio unless angle kit implies it
    // LSRR scaling: if ratio changes, new_LSRR = old_LSRR √ó (new_ratio / old_ratio)
    // Since we're not changing ratio directly in v4, keep LSRR
    // Rack travel LUT: if steer_lock changes and LUT exists, we need to extend/scale it

    // Brakes
    let brakeTorque = stock.brake_torque, brakeBias = stock.brake_bias;
    if (brakeKit.torque_mult > 1) {
        brakeTorque = Math.round(stock.brake_torque * brakeKit.torque_mult);
        brakeBias = brakeKit.bias;
    }

    // Diff
    const diffPower = diff.power !== null ? diff.power : stock.diff_power;
    const diffCoast = diff.coast !== null ? diff.coast : stock.diff_coast;
    const diffPreload = diff.preload !== null ? diff.preload : stock.diff_preload;

    // Turbo ‚Äî modify engine.ini TURBO_0 section and scale power.lut
    let turboChanges = null;
    let powerLutModified = null;
    let estimatedHP = stock.peak_hp;

    if (sel.turbo !== 'none' && turbo.max_boost > 0) {
        turboChanges = {
            MAX_BOOST: turbo.max_boost,
            WASTEGATE: turbo.wastegate,
            LAG_UP: turbo.lag_up,
            LAG_DN: turbo.lag_dn,
            REFERENCE: turbo.reference,
            GAMMA: turbo.gamma,
        };
        // Scale power.lut by turbo power multiplier
        const powerCurveName = getVal(S.parsed['engine.ini'] || {}, 'HEADER', 'POWER_CURVE', 'power.lut');
        if (S.lutFiles[powerCurveName]) {
            const origLut = parseLut(S.lutFiles[powerCurveName]);
            // For turbo: engine torque is multiplied by (1 + boost) at full boost
            // The power.lut already represents NA torque. We scale it by the mult factor
            // to represent the new base torque that turbo will multiply
            const scaleFactor = turbo.power_mult;
            powerLutModified = origLut.map(([rpm, torque]) => [rpm, Math.round(torque * scaleFactor * 100) / 100]);
            // Recalculate peak HP
            let peakHP = 0;
            for (const [rpm, torque] of powerLutModified) {
                const hp = torque * rpm / 7023;
                if (hp > peakHP) peakHP = Math.round(hp);
            }
            estimatedHP = peakHP;
        }
    } else if (sel.engine !== 'stock' && engine.hp > 0) {
        // Engine swap: scale power curve to match target HP
        const powerCurveName = getVal(S.parsed['engine.ini'] || {}, 'HEADER', 'POWER_CURVE', 'power.lut');
        if (S.lutFiles[powerCurveName] && stock.peak_hp > 0) {
            const origLut = parseLut(S.lutFiles[powerCurveName]);
            const scaleFactor = engine.hp / stock.peak_hp;
            powerLutModified = origLut.map(([rpm, torque]) => [rpm, Math.round(torque * scaleFactor * 100) / 100]);
            estimatedHP = engine.hp;
        }
    }

    // Rack travel LUT handling
    let rackLutModified = null;
    if (stock.has_rack_lut && steerLock !== stock.steer_lock && S.lutFiles[stock.rack_lut_name]) {
        const origRackLut = parseLut(S.lutFiles[stock.rack_lut_name]);
        if (origRackLut.length > 0) {
            // Scale: extend or compress the LUT to match new steer lock
            const origMaxDeg = origRackLut[origRackLut.length - 1][0];
            const scaleFactor = steerLock / stock.steer_lock;
            // Generate new entries covering 0 to new steerLock
            rackLutModified = [];
            const step = origMaxDeg > 0 ? origMaxDeg / (origRackLut.length - 1) : 2.5;
            const newStep = step; // keep same angular step
            const numEntries = Math.ceil(steerLock / newStep) + 1;
            for (let i = 0; i < numEntries; i++) {
                const deg = Math.min(i * newStep, steerLock);
                // Interpolate from original LUT
                const origDeg = deg / scaleFactor;
                let travel = 0;
                if (origDeg <= 0) travel = 0;
                else if (origDeg >= origMaxDeg) {
                    // Extrapolate linearly from last segment
                    const lastRate = origRackLut.length > 1 ?
                        (origRackLut[origRackLut.length-1][1] - origRackLut[origRackLut.length-2][1]) /
                        (origRackLut[origRackLut.length-1][0] - origRackLut[origRackLut.length-2][0]) : 0;
                    travel = origRackLut[origRackLut.length-1][1] + lastRate * (origDeg - origMaxDeg);
                } else {
                    // Linear interpolation
                    for (let j = 1; j < origRackLut.length; j++) {
                        if (origRackLut[j][0] >= origDeg) {
                            const t = (origDeg - origRackLut[j-1][0]) / (origRackLut[j][0] - origRackLut[j-1][0]);
                            travel = origRackLut[j-1][1] + t * (origRackLut[j][1] - origRackLut[j-1][1]);
                            break;
                        }
                    }
                }
                // Scale travel proportionally ‚Äî more lock = more total travel
                rackLutModified.push([Math.round(deg * 100) / 100, Math.round(travel * scaleFactor * 1000000) / 1000000]);
            }
        }
    }

    // Build INI changes
    const changes = {};
    
    // car.ini
    const carChanges = { BASIC: {}, CONTROLS: {} };
    if (totalMass !== stock.total_mass) carChanges.BASIC.TOTALMASS = totalMass;
    if (steerLock !== stock.steer_lock) carChanges.CONTROLS.STEER_LOCK = Math.round(steerLock);
    if (Object.keys(carChanges.BASIC).length || Object.keys(carChanges.CONTROLS).length) {
        changes['car.ini'] = {};
        if (Object.keys(carChanges.BASIC).length) changes['car.ini'].BASIC = carChanges.BASIC;
        if (Object.keys(carChanges.CONTROLS).length) changes['car.ini'].CONTROLS = carChanges.CONTROLS;
    }

    // suspensions.ini
    const susChanges = {};
    if (wdf !== stock.weight_dist_f) susChanges.BASIC = { CG_LOCATION: Math.round(wdf * 1000) / 1000 };
    if (hubF !== stock.hub_mass_f) { if (!susChanges.FRONT) susChanges.FRONT = {}; susChanges.FRONT.HUB_MASS = Math.round(hubF * 10000) / 10000; }
    // Spring rate changes depend on suspension type
    if (coilover.spring_f > 0) {
        const isCosmic = S.suspTypes.front.startsWith('COSMIC') || S.suspTypes.rear.startsWith('COSMIC');
        if (isCosmic) {
            susChanges.FRONT_COILOVER_0 = { RATE: springF };
            susChanges.REAR_COILOVER_0 = { RATE: springR };
        } else {
            if (!susChanges.FRONT) susChanges.FRONT = {};
            if (!susChanges.REAR) susChanges.REAR = {};
            susChanges.FRONT.SPRING_RATE = springF;
            susChanges.REAR.SPRING_RATE = springR;
        }
    }
    if (arbF !== stock.arb_f || arbR !== stock.arb_r) susChanges.ARB = { FRONT: arbF, REAR: arbR };
    if (Object.keys(susChanges).length) changes['suspensions.ini'] = susChanges;

    // drivetrain.ini
    const dtChanges = {};
    if (diffPower !== stock.diff_power || diffCoast !== stock.diff_coast || diffPreload !== stock.diff_preload) {
        dtChanges.DIFFERENTIAL = { POWER: diffPower, COAST: diffCoast, PRELOAD: diffPreload };
    }
    if (dtChanged && sel.drivetrain) {
        dtChanges.TRACTION = { TYPE: sel.drivetrain };
    }
    if (Object.keys(dtChanges).length) changes['drivetrain.ini'] = dtChanges;

    // brakes.ini
    if (brakeKit.torque_mult > 1) {
        changes['brakes.ini'] = { DATA: { MAX_TORQUE: brakeTorque, FRONT_SHARE: brakeBias } };
    }

    // engine.ini ‚Äî turbo
    if (turboChanges) {
        changes['engine.ini'] = { TURBO_0: turboChanges };
    }

    // tyres.ini ‚Äî compound
    if (sel.compound !== 'street') {
        changes['tyres.ini'] = {
            FRONT: { DX_REF: compound.dx, DY_REF: compound.dy },
            REAR: { DX_REF: compound.dx, DY_REF: compound.dy },
        };
    }

    // Comparison data
    const comparison = [];
    const cmp = (cat, param, sv, mv, unit='') => {
        comparison.push({ category: cat, param, stock: `${sv}${unit}`, modified: `${mv}${unit}` });
    };
    cmp('chassis', 'Total Mass', stock.total_mass, totalMass, ' kg');
    cmp('chassis', 'Weight Distribution (F)', (stock.weight_dist_f*100).toFixed(1)+'%', (wdf*100).toFixed(1)+'%');
    cmp('chassis', 'Drivetrain', stock.drivetrain_type, sel.drivetrain || stock.drivetrain_type);
    cmp('engine', 'Estimated Peak HP', stock.peak_hp || '?', estimatedHP || '?', ' hp');
    if (turboChanges) {
        cmp('engine', 'Turbo Max Boost', S.hasExistingTurbo ? S.existingTurbo.max_boost+' bar' : 'N/A', turbo.max_boost+' bar');
    }
    cmp('suspension', 'Spring Rate (F)', stock.spring_rate_f.toLocaleString(), Math.round(springF).toLocaleString(), ' N/m');
    cmp('suspension', 'Spring Rate (R)', stock.spring_rate_r.toLocaleString(), Math.round(springR).toLocaleString(), ' N/m');
    cmp('suspension', 'Nat. Frequency (F)', stock.freq_f, fn(springF, sprungF), ' Hz');
    cmp('suspension', 'Nat. Frequency (R)', stock.freq_r, fn(springR, sprungR), ' Hz');
    cmp('suspension', 'ARB Front', stock.arb_f.toLocaleString(), arbF.toLocaleString(), ' N/m');
    cmp('suspension', 'ARB Rear', stock.arb_r.toLocaleString(), arbR.toLocaleString(), ' N/m');
    cmp('unsprung', 'Hub Mass (F)', stock.hub_mass_f, Math.round(hubF*10)/10, ' kg');
    cmp('steering', 'Steer Lock', stock.steer_lock+'¬∞', Math.round(steerLock)+'¬∞');
    cmp('steering', 'Max Steering Angle', stock.max_angle+'¬∞', maxAngle+'¬∞');
    cmp('brakes', 'Brake Torque', stock.brake_torque, brakeTorque, ' Nm');
    cmp('brakes', 'Brake Bias', (stock.brake_bias*100).toFixed(0)+'% F', (brakeBias*100).toFixed(0)+'% F');
    cmp('diff', 'Power Lock', (stock.diff_power*100).toFixed(0)+'%', (diffPower*100).toFixed(0)+'%');
    cmp('diff', 'Coast Lock', (stock.diff_coast*100).toFixed(0)+'%', (diffCoast*100).toFixed(0)+'%');
    cmp('diff', 'Preload', stock.diff_preload+' Nm', diffPreload+' Nm');

    // Generate setup.ini content
    const setupIni = generateSetupIni();

    S.result = {
        changes, comparison, powerLutModified, rackLutModified, turboChanges, setupIni,
        summary: {
            total_mass: totalMass, wdf, estimated_hp: estimatedHP,
            freq_f: fn(springF, sprungF), freq_r: fn(springR, sprungR),
            max_angle: maxAngle, hub_f: Math.round(hubF*10)/10, hub_r: Math.round(hubR*10)/10,
            coilovers: coilover, angle_kit: angleKit, brakes: brakeKit, diff, compound, engine, turbo,
            drivetrain: sel.drivetrain || stock.drivetrain_type,
        },
    };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETUP.INI GENERATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateSetupIni() {
    const st = S.stock;
    const ft = S.suspTypes.front;
    const rt = S.suspTypes.rear;
    const isCosmic = ft.startsWith('COSMIC') || rt.startsWith('COSMIC');
    
    let ini = `[DISPLAY_METHOD]\nSHOW_CLICKS=1\n\n`;
    
    // Fuel
    ini += `[FUEL]\nSHOW_CLICKS=0\nTAB=GENERIC\nNAME=Fuel\nMIN=0\nMAX=50\nSTEP=1\nPOS_X=0.5\nPOS_Y=0\nHELP=More fuel = heavier. Less fuel = lighter.\n\n`;
    
    // Brake controls
    ini += `[BRAKE_POWER_MULT]\nSHOW_CLICKS=0\nTAB=DIFFERENTIAL\nNAME=(Brake Power)\nMIN=5\nMAX=100\nSTEP=5\nPOS_X=0.5\nPOS_Y=2.75\nHELP="Higher = stronger braking. Lower = smoother stops"\n\n`;
    ini += `[FRONT_BIAS]\nSHOW_CLICKS=0\nTAB=DIFFERENTIAL\nNAME=(Brake Bias)\nMIN=20\nMAX=70\nSTEP=1\nPOS_X=0.5\nPOS_Y=3.75\nHELP="More Front = Stability | More Rear = Rotation"\n\n`;
    ini += `[STEER_ASSIST]\nSHOW_CLICKS=0\nTAB=DIFFERENTIAL\nNAME=FFB (Less=Heavier)\nMIN=0\nMAX=150\nSTEP=5\nPOS_X=0.5\nPOS_Y=1\nHELP="(-) = Stronger Wheel | (+) = Lighter Wheel"\n\n`;

    // Front setup
    ini += `; ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRONT SETUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    
    if (isCosmic) {
        // COSMIC front ‚Äî ride height via preload
        ini += `[SPRING_PRELOAD_LF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=(Ride Height)\nMIN=-500\nMAX=100\nSTEP=10\nPOS_X=0.5\nPOS_Y=0\nHELP="(+) Higher | (-) Lower"\n\n`;
        ini += `[SPRING_PRELOAD_RF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=(Ride Height)\nMIN=-500\nMAX=100\nSTEP=10\nPOS_X=0.5\nPOS_Y=0\nHELP="(+) Higher | (-) Lower"\n\n`;
    }

    // Front springs (LUT-based for adjustable coilovers)
    ini += `[SPRING_RATE_LF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=Spring Rate\nLUT=suspensions_springs_front_drift.lut\nPOS_X=1\nPOS_Y=1\nHELP="(+) Stiffer | (-) Softer"\n\n`;
    ini += `[SPRING_RATE_RF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=Spring Rate\nLUT=suspensions_springs_front_drift.lut\nPOS_X=1\nPOS_Y=1\nHELP="(+) Stiffer | (-) Softer"\n\n`;

    // Front dampers
    ini += `[DAMPER_BUMP_LF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=Bump\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=3\nHELP="(+) Faster weight transfer | (-) Slower"\n\n`;
    ini += `[DAMPER_BUMP_RF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=Bump\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=3\nHELP="(+) Faster weight transfer | (-) Slower"\n\n`;
    ini += `[DAMPER_REBOUND_LF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=Rebound\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=5\nHELP="(+) Keeps nose down | (-) Nose rises faster"\n\n`;
    ini += `[DAMPER_REBOUND_RF_C0]\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=Rebound\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=5\nHELP="(+) Keeps nose down | (-) Nose rises faster"\n\n`;

    // Front ARB
    ini += `[ARB_F]\nEXTEND=1\nSHOW_CLICKS=0\nTAB=FRONT SETUP\nNAME=Anti-Roll Bar\nLUT=suspensions_stabilizer_front_drift.lut\nPOS_X=0.5\nPOS_Y=7\nHELP="Stiffer = More turn-in | Softer = More front grip"\nDISPLAY_VALUE_IN_BRACKETS=0\n\n`;

    // Front alignment ‚Äî depends on suspension type
    if (isCosmic) {
        // Camber adjustment
        if (!isStrutFront(ft)) {
            // DWB: camber via DJ offset
            ini += `[DJ2_LENGTH_OFFSET_LF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=(Camber)\nMIN=-500\nMAX=1000\nSTEP=10\nPOS_X=0.5\nPOS_Y=1\nHELP="(-) = More grip | (+) = Less camber"\n\n`;
            ini += `[DJ2_LENGTH_OFFSET_RF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=(Camber)\nMIN=-500\nMAX=1000\nSTEP=10\nPOS_X=0.5\nPOS_Y=1\nHELP="(-) = More grip | (+) = Less camber"\n\n`;
        } else {
            // Strut: camber via DJ3 (strut camber)
            ini += `[DJ3_LENGTH_OFFSET_LF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Strut (Camber 0.1mm)\nMIN=-300\nMAX=300\nSTEP=10\nPOS_X=0\nPOS_Y=1\nHELP="Adjusts front camber"\n\n`;
            ini += `[DJ3_LENGTH_OFFSET_RF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Strut (Camber 0.1mm)\nMIN=-300\nMAX=300\nSTEP=10\nPOS_X=1\nPOS_Y=1\nHELP="Adjusts front camber"\n\n`;
        }
        
        // Toe
        ini += `[STEER_JOINT_0_LENGTH_OFFSET_LF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Steer (Toe 0.1mm)\nMIN=-300\nMAX=300\nSTEP=1\nPOS_X=0\nPOS_Y=3\nHELP="(+) Toe Out | (-) Toe In"\n\n`;
        ini += `[STEER_JOINT_0_LENGTH_OFFSET_RF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Steer (Toe 0.1mm)\nMIN=-300\nMAX=300\nSTEP=1\nPOS_X=1\nPOS_Y=3\nHELP="(+) Toe Out | (-) Toe In"\n\n`;

        // Caster (strut types have DJ4)
        if (isStrutFront(ft)) {
            ini += `[DJ4_LENGTH_OFFSET_LF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Strut (Caster 0.1mm)\nMIN=0\nMAX=200\nSTEP=10\nPOS_X=0\nPOS_Y=4\nHELP="(+) More self-steer"\n\n`;
            ini += `[DJ4_LENGTH_OFFSET_RF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Strut (Caster 0.1mm)\nMIN=0\nMAX=200\nSTEP=10\nPOS_X=1\nPOS_Y=4\nHELP="(+) More self-steer"\n\n`;
        }
    } else {
        // Standard suspension ‚Äî basic camber/toe
        ini += `[CAMBER_LF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Camber\nMIN=-5\nMAX=0\nSTEP=0.1\nPOS_X=0\nPOS_Y=0\nHELP=HELP_LF_CAMBER\n\n`;
        ini += `[CAMBER_RF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Camber\nMIN=-5\nMAX=0\nSTEP=0.1\nPOS_X=1\nPOS_Y=0\nHELP=HELP_RF_CAMBER\n\n`;
        ini += `[TOE_OUT_LF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Toe\nMIN=-1\nMAX=1\nSTEP=0.05\nPOS_X=0\nPOS_Y=1\nHELP=HELP_LF_TOE\n\n`;
        ini += `[TOE_OUT_RF]\nSHOW_CLICKS=0\nTAB=ALIGNMENT FRONT\nNAME=Toe\nMIN=-1\nMAX=1\nSTEP=0.05\nPOS_X=1\nPOS_Y=1\nHELP=HELP_RF_TOE\n\n`;
    }

    // Rear setup
    ini += `; ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REAR SETUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    
    if (isCosmic) {
        ini += `[SPRING_PRELOAD_LR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=(Ride Height)\nMIN=-500\nMAX=100\nSTEP=10\nPOS_X=0.5\nPOS_Y=0\nHELP="(+) Higher | (-) Lower"\n\n`;
        ini += `[SPRING_PRELOAD_RR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=(Ride Height)\nMIN=-500\nMAX=100\nSTEP=10\nPOS_X=0.5\nPOS_Y=0\nHELP="(+) Higher | (-) Lower"\n\n`;
    }

    ini += `[SPRING_RATE_LR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=Spring Rate\nLUT=suspensions_springs_rear_drift.lut\nPOS_X=1\nPOS_Y=1\nHELP="(+) Stiffer | (-) Softer"\n\n`;
    ini += `[SPRING_RATE_RR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=Spring Rate\nLUT=suspensions_springs_rear_drift.lut\nPOS_X=1\nPOS_Y=1\nHELP="(+) Stiffer | (-) Softer"\n\n`;

    ini += `[DAMPER_BUMP_LR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=Bump\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=3\nHELP="(+) Stiffer hit | (-) Smoother"\n\n`;
    ini += `[DAMPER_BUMP_RR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=Bump\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=3\nHELP="(+) Stiffer hit | (-) Smoother"\n\n`;
    ini += `[DAMPER_REBOUND_LR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=Rebound\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=5\nHELP="(+) Slower squat recovery | (-) Faster"\n\n`;
    ini += `[DAMPER_REBOUND_RR_C0]\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=Rebound\nMIN=0\nMAX=20\nSTEP=1\nDEFAULT=10\nPOS_X=1\nPOS_Y=5\nHELP="(+) Slower squat recovery | (-) Faster"\n\n`;

    ini += `[ARB_R]\nEXTEND=1\nSHOW_CLICKS=0\nTAB=REAR SETUP\nNAME=Anti-Roll Bar\nLUT=suspensions_stabilizer_rear_drift.lut\nPOS_X=0.5\nPOS_Y=7\nHELP="Stiffer = Faster transition | Softer = More rear stability"\nDISPLAY_VALUE_IN_BRACKETS=0\n\n`;

    // Rear alignment
    if (isCosmic && !isAxleRear(rt)) {
        // Multi-link / DWB rear: camber + toe adjustable
        ini += `[STEER_JOINT_0_LENGTH_OFFSET_LR]\nSHOW_CLICKS=0\nTAB=ALIGNMENT REAR\nNAME=(Toe 0.1mm)\nMIN=-200\nMAX=200\nSTEP=1\nPOS_X=0.5\nPOS_Y=2\nHELP="(-) Stable | (+) Looser"\n\n`;
        ini += `[STEER_JOINT_0_LENGTH_OFFSET_RR]\nSHOW_CLICKS=0\nTAB=ALIGNMENT REAR\nNAME=(Toe 0.1mm)\nMIN=-200\nMAX=200\nSTEP=1\nPOS_X=0.5\nPOS_Y=2\nHELP="(-) Stable | (+) Looser"\n\n`;
    } else if (isCosmic && isAxleRear(rt)) {
        // Solid axle: no camber/toe. Maybe panhard height
    } else {
        // Standard rear
        ini += `[CAMBER_LR]\nSHOW_CLICKS=0\nTAB=ALIGNMENT REAR\nNAME=Camber\nMIN=-5\nMAX=0\nSTEP=0.1\nPOS_X=0\nPOS_Y=0\nHELP=HELP_LR_CAMBER\n\n`;
        ini += `[CAMBER_RR]\nSHOW_CLICKS=0\nTAB=ALIGNMENT REAR\nNAME=Camber\nMIN=-5\nMAX=0\nSTEP=0.1\nPOS_X=1\nPOS_Y=0\nHELP=HELP_RR_CAMBER\n\n`;
        ini += `[TOE_OUT_LR]\nSHOW_CLICKS=0\nTAB=ALIGNMENT REAR\nNAME=Toe\nMIN=-1\nMAX=1\nSTEP=0.05\nPOS_X=0\nPOS_Y=1\nHELP=HELP_LR_TOE\n\n`;
        ini += `[TOE_OUT_RR]\nSHOW_CLICKS=0\nTAB=ALIGNMENT REAR\nNAME=Toe\nMIN=-1\nMAX=1\nSTEP=0.05\nPOS_X=1\nPOS_Y=1\nHELP=HELP_RR_TOE\n\n`;
    }

    // Diff setup
    ini += `; ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DIFFERENTIAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    ini += `[DIFF_RAMP_POWER]\nSHOW_CLICKS=0\nTAB=DIFFERENTIAL\nNAME=Diff Power\nLUT=drivetrain_diff_power.lut\nPOS_X=0.5\nPOS_Y=6\nHELP=HELP_DIFF_POWER\n\n`;
    ini += `[DIFF_PRELOAD_EXT]\nSHOW_CLICKS=0\nTAB=DIFFERENTIAL\nNAME=Diff Preload\nLUT=drivetrain_diff_preload.lut\nPOS_X=0.5\nPOS_Y=7\nHELP=HELP_DIFF_PRELOAD\n\n`;

    return ini;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function goStep(n) {
    S.step = n;
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + n).classList.add('active');
    document.querySelectorAll('.progress-step').forEach(d => {
        const ds = +d.dataset.step;
        d.className = 'progress-step' + (ds < n ? ' done' : ds === n ? ' current' : '');
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ Drop zone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dz = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const folderInput = document.getElementById('folderInput');

dz.addEventListener('click', e => { if (e.shiftKey) folderInput.click(); else fileInput.click(); });
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); handleDrop(e.dataTransfer); });
fileInput.addEventListener('change', e => processFiles(Array.from(e.target.files)));
folderInput.addEventListener('change', e => processFiles(Array.from(e.target.files)));

async function handleDrop(dt) {
    const items = dt.items;
    if (items?.length > 0 && items[0].webkitGetAsEntry) {
        const allFiles = [];
        const promises = [];
        for (const item of items) {
            const entry = item.webkitGetAsEntry();
            if (entry) promises.push(traverseEntry(entry, allFiles));
        }
        await Promise.all(promises);
        if (allFiles.length > 0) { processFiles(allFiles); return; }
    }
    processFiles(Array.from(dt.files));
}

function traverseEntry(entry, result) {
    return new Promise(resolve => {
        if (entry.isFile) {
            entry.file(f => { f._path = entry.fullPath; result.push(f); resolve(); });
        } else if (entry.isDirectory) {
            const reader = entry.createReader();
            const readAll = (entries = []) => {
                reader.readEntries(async batch => {
                    if (batch.length === 0) {
                        for (const e of entries) await traverseEntry(e, result);
                        resolve();
                    } else {
                        readAll([...entries, ...batch]);
                    }
                });
            };
            readAll();
        } else resolve();
    });
}

async function processFiles(files) {
    const relevant = files.filter(f => {
        const n = (f._path || f.webkitRelativePath || f.name).toLowerCase();
        return n.endsWith('.ini') || n.endsWith('.lut');
    });
    if (!relevant.length) {
        setDropMsg('‚ùå', 'No .ini or .lut files found', 'Make sure you drop the data/ folder');
        setTimeout(() => setDropMsg('üìÅ', "Drop your car's data/ folder here", 'Drag the entire data folder, or select individual files'), 3000);
        return;
    }
    setDropMsg('‚è≥', `Reading ${relevant.length} files...`, 'Parsing physics data...');
    dz.classList.add('loading');

    S.rawFiles = {};
    S.parsed = {};
    S.lutFiles = {};
    for (const f of relevant) {
        const name = f.name.toLowerCase();
        const text = await f.text();
        S.rawFiles[name] = text;
        if (name.endsWith('.ini')) S.parsed[name] = parseIni(text);
        if (name.endsWith('.lut')) S.lutFiles[name] = text;
    }

    // Also store lut filenames referenced in INIs that might have different casing
    for (const f of relevant) {
        const name = f.name;
        const text = await f.text();
        if (name.endsWith('.lut') && !S.lutFiles[name]) S.lutFiles[name] = text;
    }

    if (!S.parsed['car.ini'] && !S.parsed['suspensions.ini']) {
        setDropMsg('‚ùå', 'No car.ini or suspensions.ini found', 'Make sure you upload from the data/ folder');
        dz.classList.remove('loading');
        setTimeout(() => setDropMsg('üìÅ', "Drop your car's data/ folder here", 'Drag the entire data folder, or select individual files'), 3000);
        return;
    }

    detectCar();
    dz.classList.remove('loading');

    const fileCount = Object.keys(S.rawFiles).length;
    setDropMsg('‚úÖ', `${S.carInfo.name} ‚Äî ${fileCount} files loaded`, 'Proceeding to configuration...');

    // Reset selections
    S.sel = { coilovers:'stock', angle_kit:'stock', brakes:'stock', diff:'stock', compound:'street', engine:'stock', turbo:'none', drivetrain: S.stock.drivetrain_type };
    S.mode = null;
    S.classKey = null;

    setTimeout(() => { renderStep2(); goStep(2); }, 500);
}

function setDropMsg(icon, title, sub) {
    dz.querySelector('.dz-icon').textContent = icon;
    dz.querySelector('.dz-title').textContent = title;
    dz.querySelector('.dz-sub').textContent = sub;
}

// ‚îÄ‚îÄ Step 2 rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStep2() {
    renderCarBanner('carBanner');
    renderDetectionCard();
    document.getElementById('quickBuild').style.display = 'none';
    document.getElementById('customBuild').style.display = 'none';
    document.getElementById('generateBtn').style.display = 'none';
    document.getElementById('modeSelect').style.display = 'grid';
    
    // Mode card click handlers
    document.querySelectorAll('.mode-card').forEach(card => {
        card.onclick = () => selectMode(card.dataset.mode);
    });
}

function renderCarBanner(id) {
    const s = S.stock;
    const c = S.carInfo;
    document.getElementById(id).innerHTML = `
        <div>
            <div class="cb-name">${c.name || c.model}</div>
            <div class="cb-detail">${c.make} ${c.model}${c.chassis ? ' ¬∑ ' + c.chassis.toUpperCase() : ''}${c.year ? ' ¬∑ ' + c.year : ''}</div>
        </div>
        <div class="cb-stats">
            <span class="cb-stat"><b>${s.total_mass}</b> kg</span>
            <span class="cb-stat"><b>${s.drivetrain_type}</b></span>
            <span class="cb-stat"><b>${(s.weight_dist_f*100).toFixed(0)}</b>/<b>${(100-s.weight_dist_f*100).toFixed(0)}</b> F/R</span>
            ${s.peak_hp ? `<span class="cb-stat"><b>~${s.peak_hp}</b> hp</span>` : ''}
        </div>`;
}

function renderDetectionCard() {
    const s = S.stock;
    const ft = S.suspTypes.front;
    const rt = S.suspTypes.rear;
    const fileCount = Object.keys(S.rawFiles).length;
    const lutCount = Object.keys(S.lutFiles).length;
    
    document.getElementById('detectionCard').innerHTML = `
        <div class="detect-card">
            <h3>üîç Detected Configuration</h3>
            <div class="detect-grid">
                <div class="detect-item"><div class="di-label">Front Suspension</div><div class="di-value highlight">${suspTypeName(ft)}</div></div>
                <div class="detect-item"><div class="di-label">Rear Suspension</div><div class="di-value highlight">${suspTypeName(rt)}</div></div>
                <div class="detect-item"><div class="di-label">Steer Lock / Ratio</div><div class="di-value">${s.steer_lock}¬∞ / ${s.steer_ratio}:1</div></div>
                <div class="detect-item"><div class="di-label">LSRR</div><div class="di-value">${s.lsrr || 'N/A'}</div></div>
                <div class="detect-item"><div class="di-label">Wheelbase</div><div class="di-value">${s.wheelbase}m</div></div>
                <div class="detect-item"><div class="di-label">Spring (F / R)</div><div class="di-value">${Math.round(s.spring_rate_f/9.81)} / ${Math.round(s.spring_rate_r/9.81)} kg/mm</div></div>
                <div class="detect-item"><div class="di-label">Hub Mass (F / R)</div><div class="di-value">${s.hub_mass_f} / ${s.hub_mass_r} kg</div></div>
                <div class="detect-item"><div class="di-label">Turbo</div><div class="di-value">${S.hasExistingTurbo ? `Yes (${S.existingTurbo.max_boost} bar)` : 'No'}</div></div>
                <div class="detect-item"><div class="di-label">Files Loaded</div><div class="di-value">${fileCount} ini ¬∑ ${lutCount} lut</div></div>
                ${isDWBFront(ft) ? '<div class="detect-item"><div class="di-label">Steer Ratio Change</div><div class="di-value highlight">‚úÖ Available (DWB)</div></div>' : ''}
                ${isAxleRear(rt) ? '<div class="detect-item"><div class="di-label">Rear Camber/Toe</div><div class="di-value" style="color:var(--red)">‚ùå Solid Axle</div></div>' : ''}
            </div>
        </div>`;
}

function selectMode(mode) {
    S.mode = mode;
    document.querySelectorAll('.mode-card').forEach(c => c.classList.toggle('selected', c.dataset.mode === mode));
    document.getElementById('generateBtn').style.display = 'inline-flex';

    if (mode === 'quick') {
        document.getElementById('quickBuild').style.display = 'block';
        document.getElementById('customBuild').style.display = 'none';
        renderQuickBuild();
    } else {
        document.getElementById('quickBuild').style.display = 'none';
        document.getElementById('customBuild').style.display = 'block';
        renderCustomBuild();
    }
}

function renderQuickBuild() {
    let html = '<h2 style="color:var(--cyan);margin-bottom:16px;font-size:1.1em">Select Build Class</h2>';
    html += '<div class="class-grid">';
    for (const cls of CLASS_PRESETS) {
        const sel = S.classKey === cls.id;
        html += `<div class="class-card${sel ? ' selected' : ''}" onclick="selectClass('${cls.id}')">
            <div class="cc-icon">${cls.icon}</div>
            <div class="cc-name">${cls.label}</div>
            <div class="cc-hp">${cls.hp}</div>
            <div class="cc-desc">${cls.desc}</div>
        </div>`;
    }
    html += '</div>';
    document.getElementById('quickBuild').innerHTML = html;
}

function selectClass(id) {
    S.classKey = id;
    const cls = CLASS_PRESETS.find(c => c.id === id);
    if (cls) {
        S.sel.coilovers = cls.coilovers;
        S.sel.angle_kit = cls.angle_kit;
        S.sel.brakes = cls.brakes;
        S.sel.diff = cls.diff;
        S.sel.compound = cls.compound;
        S.sel.engine = cls.engine;
        S.sel.turbo = cls.turbo;
    }
    renderQuickBuild();
}

function renderCustomBuild() {
    const chassis = S.detectedChassis;
    let html = '';

    // Drivetrain selector
    html += `<div class="section-hdr"><h2>‚öôÔ∏è Drivetrain Layout</h2></div>`;
    html += `<div class="dt-selector">`;
    for (const dt of ['FWD', 'RWD', 'AWD']) {
        const sel = (S.sel.drivetrain || S.stock.drivetrain_type) === dt;
        const isStock = dt === S.stock.drivetrain_type;
        const note = isStock ? 'Current' : (dt === 'RWD' ? '+30kg, CoG shift' : dt === 'AWD' ? '+50kg, DCCD system' : 'Layout change');
        html += `<div class="dt-card${sel ? ' selected' : ''}" onclick="selectDrivetrain('${dt}')">
            <div class="dtc-icon">${dt === 'FWD' ? 'üîß' : dt === 'RWD' ? 'üèéÔ∏è' : 'ü¶æ'}</div>
            <div class="dtc-name">${dt}</div>
            <div class="dtc-note">${note}</div>
        </div>`;
    }
    html += '</div>';

    // Engine swap
    html += renderPartGroup('üî• Engine Swap', ENGINE_SWAPS, 'engine', chassis, e => 
        e.id === 'stock' ? 'Keep original' : `${e.weight_kg}kg ¬∑ ${e.hp}hp stock`
    );

    // Turbo
    html += `<div class="section-hdr"><h2>üåÄ Turbo</h2>${S.hasExistingTurbo ? '<span class="sh-badge">Car has existing turbo</span>' : ''}</div>`;
    html += `<div class="turbo-grid">`;
    for (const t of TURBO_SIZES) {
        const sel = S.sel.turbo === t.id;
        html += `<div class="turbo-card${sel ? ' selected' : ''}" onclick="selectPart('turbo','${t.id}');renderCustomBuild()">
            <div class="tc-icon">${t.icon}</div>
            <div class="tc-name">${t.name}</div>
            <div class="tc-spec">${t.spec}</div>
            <div class="tc-desc">${t.desc}</div>
        </div>`;
    }
    html += '</div>';

    // Coilovers
    html += '<div class="parts-section"><div class="section-hdr"><h2>üîß Suspension & Handling</h2></div><div class="parts-grid">';
    html += renderPartGroupInner('Coilovers', COILOVERS, 'coilovers', chassis, c => 
        c.spring_f > 0 ? `${Math.round(c.spring_f/9810)}/${Math.round(c.spring_r/9810)} kg/mm ¬∑ ${c.quality}` : 'Stock rates'
    );
    html += renderPartGroupInner('Angle Kit', ANGLE_KITS, 'angle_kit', chassis, a => 
        a.angle > 0 ? `${a.angle}¬∞ max ¬∑ +${a.hub_add}kg hub` : 'Stock angle'
    );
    html += '</div></div>';

    // Brakes + Diff
    html += '<div class="parts-section"><div class="section-hdr"><h2>üõë Brakes & Differential</h2></div><div class="parts-grid">';
    html += renderPartGroupInner('Brakes', BRAKE_KITS, 'brakes', chassis, b => 
        b.torque_mult > 1 ? `+${Math.round((b.torque_mult-1)*100)}% torque ¬∑ +${b.mass_add}kg` : 'Stock'
    );
    html += renderPartGroupInner('Differential', DIFFS, 'diff', chassis, d => 
        d.power !== null ? `${Math.round(d.power*100)}% power ¬∑ ${Math.round(d.coast*100)}% coast` : 'Stock'
    );
    html += '</div></div>';

    // Tire compound
    html += '<div class="parts-section"><div class="section-hdr"><h2>üèÅ Tire Compound</h2></div><div class="parts-grid">';
    html += renderPartGroupInner('Compound', COMPOUNDS, 'compound', chassis, c => `Grip: ${c.grip.toFixed(2)}x`);
    html += '</div></div>';

    document.getElementById('customBuild').innerHTML = html;
}

function renderPartGroup(title, items, selKey, chassis, specFn) {
    return `<div class="section-hdr"><h2>${title}</h2></div>` + 
        `<div class="parts-grid">${renderPartGroupInner(title, items, selKey, chassis, specFn)}</div>`;
}

function renderPartGroupInner(title, items, selKey, chassis, specFn) {
    let html = `<div class="part-group"><h3>${title}</h3>`;
    for (const item of items) {
        const compat = isCompat(item.compatible, chassis);
        const sel = S.sel[selKey] === item.id;
        html += `<div class="part-option${sel ? ' selected' : ''}${!compat ? ' disabled' : ''}" 
            onclick="selectPart('${selKey}','${item.id}');renderCustomBuild()">
            <div class="po-brand">${item.brand || ''}</div>
            <div class="po-name">${item.name}</div>
            <div class="po-desc">${item.desc || ''}</div>
            <div class="po-spec">${specFn(item)}</div>
        </div>`;
    }
    html += '</div>';
    return html;
}

function selectPart(key, val) { S.sel[key] = val; }
function selectDrivetrain(dt) { S.sel.drivetrain = dt; renderCustomBuild(); }

// ‚îÄ‚îÄ Generate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generatePhysics() {
    if (S.mode === 'quick' && !S.classKey) { toast('Please select a class first!'); return; }
    calculatePhysics();
    renderResults();
    goStep(3);
}

// ‚îÄ‚îÄ Step 3 rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults() {
    const r = S.result;
    const sm = r.summary;
    const c = S.carInfo;

    // Banner
    const partNames = [sm.coilovers, sm.angle_kit, sm.brakes, sm.diff, sm.engine, sm.turbo]
        .filter(p => p && p.id !== 'stock' && p.id !== 'none')
        .map(p => `${p.brand} ${p.name}`);
    document.getElementById('resultBanner').innerHTML = `
        <div>
            <div class="cb-name">${c.name}${sm.engine.id !== 'stock' ? ' ‚Äî ' + sm.engine.name + ' Swap' : ''}</div>
            <div class="cb-detail">${partNames.join(' ¬∑ ') || 'Stock configuration'}</div>
        </div>
        <div class="cb-stats">
            <span class="cb-stat"><b>${sm.total_mass}</b> kg</span>
            <span class="cb-stat"><b>${sm.drivetrain}</b></span>
            <span class="cb-stat"><b>~${sm.estimated_hp || '?'}</b> hp</span>
        </div>`;

    // Summary cards
    const delta = (nv, ov) => {
        if (typeof nv !== 'number' || typeof ov !== 'number') return '';
        const d = nv - ov;
        if (Math.abs(d) < 0.01) return '<div class="sc-delta neutral">‚Äî</div>';
        return `<div class="sc-delta ${d > 0 ? 'up' : 'down'}">${d > 0 ? '+' : ''}${d.toFixed(1)}</div>`;
    };
    const cards = [
        ['Mass', sm.total_mass, 'kg', delta(sm.total_mass, S.stock.total_mass)],
        ['Wt Dist', `${(sm.wdf*100).toFixed(1)}/${(100-sm.wdf*100).toFixed(1)}`, 'F/R', ''],
        ['Est. HP', sm.estimated_hp || '?', 'hp', ''],
        ['Freq F', sm.freq_f, 'Hz', delta(sm.freq_f, S.stock.freq_f)],
        ['Freq R', sm.freq_r, 'Hz', delta(sm.freq_r, S.stock.freq_r)],
        ['Max Angle', sm.max_angle, '¬∞', delta(sm.max_angle, S.stock.max_angle)],
        ['Hub F', sm.hub_f, 'kg', delta(sm.hub_f, S.stock.hub_mass_f)],
    ];
    document.getElementById('summaryGrid').innerHTML = cards.map(([l, v, u, d]) =>
        `<div class="summary-card"><div class="sc-label">${l}</div><div class="sc-value">${v} <span class="sc-unit">${u}</span></div>${d}</div>`
    ).join('');

    // Files list
    const modifiedFiles = Object.keys(r.changes);
    const addedFiles = [];
    if (r.powerLutModified) addedFiles.push('power.lut (scaled)');
    if (r.rackLutModified) addedFiles.push(S.stock.rack_lut_name + ' (scaled)');
    if (r.setupIni) addedFiles.push('setup.ini (generated)');

    let filesHtml = '<div class="files-list"><h3>üì¶ Output Files</h3>';
    for (const f of modifiedFiles) {
        filesHtml += `<div class="file-item"><span class="fi-icon">üìù</span><span class="fi-name">${f}</span><span class="fi-status modified">Modified</span></div>`;
    }
    for (const f of addedFiles) {
        filesHtml += `<div class="file-item"><span class="fi-icon">‚ûï</span><span class="fi-name">${f}</span><span class="fi-status added">Generated</span></div>`;
    }
    // Unmodified files
    for (const f of Object.keys(S.rawFiles)) {
        if (!modifiedFiles.includes(f) && !f.endsWith('.lut')) {
            filesHtml += `<div class="file-item"><span class="fi-icon">üìÑ</span><span class="fi-name">${f}</span><span class="fi-status copied">Copied</span></div>`;
        }
    }
    filesHtml += '</div>';
    document.getElementById('filesList').innerHTML = filesHtml;

    // Comparison tables
    const cats = {
        chassis: 'Chassis', engine: 'Engine', suspension: 'Suspension',
        unsprung: 'Unsprung Mass', steering: 'Steering', brakes: 'Brakes', diff: 'Differential'
    };
    const tables = document.getElementById('comparisonTables');
    tables.innerHTML = '';
    for (const [ck, cn] of Object.entries(cats)) {
        const items = r.comparison.filter(c => c.category === ck);
        if (!items.length) continue;
        let h = `<div class="comp-section"><h3>${cn}</h3><table><tr><th>Parameter</th><th>Stock</th><th>Modified</th></tr>`;
        for (const it of items) {
            const ch = it.stock !== it.modified;
            h += `<tr><td>${it.param}</td><td class="stock">${it.stock}</td><td class="${ch ? 'changed' : 'stock'}">${it.modified}</td></tr>`;
        }
        tables.innerHTML += h + '</table></div>';
    }
}

// ‚îÄ‚îÄ Download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function downloadZip() {
    const r = S.result;
    const zip = new JSZip();
    const dataFolder = zip.folder('data');

    // Apply changes to raw files
    for (const [fname, content] of Object.entries(S.rawFiles)) {
        let modified = content;
        if (r.changes[fname]) {
            modified = applyIniChanges(content, r.changes[fname]);
        }
        dataFolder.file(fname, modified);
    }

    // LUT files ‚Äî copy all, but replace modified ones
    for (const [fname, content] of Object.entries(S.lutFiles)) {
        if (!S.rawFiles[fname]) { // Don't double-add
            dataFolder.file(fname, content);
        }
    }

    // Modified power.lut
    if (r.powerLutModified) {
        const powerCurveName = getVal(S.parsed['engine.ini'] || {}, 'HEADER', 'POWER_CURVE', 'power.lut');
        dataFolder.file(powerCurveName, lutToString(r.powerLutModified));
    }

    // Modified rack travel LUT
    if (r.rackLutModified && S.stock.rack_lut_name) {
        dataFolder.file(S.stock.rack_lut_name, lutToString(r.rackLutModified));
    }

    // Turbo section ‚Äî if adding new turbo to engine.ini that didn't have one
    if (r.turboChanges && !S.hasExistingTurbo && S.rawFiles['engine.ini']) {
        let engContent = S.rawFiles['engine.ini'];
        if (r.changes['engine.ini']) {
            engContent = applyIniChanges(engContent, r.changes['engine.ini']);
        }
        // Append TURBO_0 section if not present
        if (!/\[TURBO_0\]/i.test(engContent)) {
            engContent += `\n\n[TURBO_0]\nMAX_BOOST=${r.turboChanges.MAX_BOOST}\nWASTEGATE=${r.turboChanges.WASTEGATE}\nLAG_UP=${r.turboChanges.LAG_UP}\nLAG_DN=${r.turboChanges.LAG_DN}\nREFERENCE=${r.turboChanges.REFERENCE}\nGAMMA=${r.turboChanges.GAMMA}\n`;
        }
        dataFolder.file('engine.ini', engContent);
    }

    // Generated setup.ini
    if (r.setupIni) {
        dataFolder.file('setup.ini', r.setupIni);
    }

    // Include spring/ARB/damper LUT files from reference
    const springLutF = `AE86 Stock (3kg/mm) | 29430\nS13 Stock (4kg/mm) | 39240\nS14 Stock (5kg/mm) | 49050\nFD3S Stock (6kg/mm) | 58860\nChallenger Stock (350 lbs/in) | 45141\nCorvette Stock (400 lbs/in) | 51571\nCamaro Stock (450 lbs/in) | 58860\nMustang Stock (500 lbs/in) | 64431\nAE86 Drift (7kg/mm) | 68670\nCamaro Drift (550 lbs/in) | 70862\nMustang Drift (600 lbs/in) | 78480\nE46 Drift (8kg/mm) | 78480\nS Chassis Drift (9kg/mm) | 88290\nFD3S Drift (10kg/mm) | 98100\nCamaro Drift (700 lbs/in) | 90192\nCorvette Drift (12kg/mm) | 117720\nCorvette Track (14kg/mm) | 137340`;
    const springLutR = `AE86 Stock (2kg/mm) | 19620\nS13 Stock (3kg/mm) | 29430\nS14 Stock (4kg/mm) | 39240\nFD3S Stock (5kg/mm) | 49050\nChallenger Stock (300 lbs/in) | 38711\nCorvette Stock (350 lbs/in) | 45141\nCamaro Stock (400 lbs/in) | 51571\nMustang Stock (450 lbs/in) | 58860\nAE86 Drift (6kg/mm) | 58860\nCamaro Drift (500 lbs/in) | 64431\nE46 Drift (7kg/mm) | 68670\nMustang Drift (550 lbs/in) | 70862\nS Chassis Drift (8kg/mm) | 78480\nFD3S Drift (9kg/mm) | 88290\nCorvette Drift (10kg/mm) | 98100\nCorvette Track (12kg/mm) | 117720`;
    const arbLutF = `None | 0\n0.500 in | 0\nAE86 Stock (0.625 in) | 18750\nS13 Stock | 16812\nS14 Stock (0.750 in) | 37500\nFD3S Stock | 43693\nE36 Stock (0.875 in) | 56250\nMustang Stock (1.000 in) | 75000\nCamaro Stock (1.125 in) | 93750\nCorvette Stock (1.250 in) | 112500`;
    const arbLutR = `None | 0\n0.500 in | 8404\nAE86 Stock (0.625 in) | 18750\nS13 Stock (0.750 in) | 37500\nS14 Stock (0.875 in) | 56250\nFD3S Stock (1.000 in) | 75000\nE36 Stock (1.125 in) | 93750\nMustang Stock (1.250 in) | 112500\nCamaro Stock (1.375 in) | 131250\nCorvette Stock (1.500 in) | 150000`;

    // Only include LUT files if they're not already in the data
    if (!S.lutFiles['suspensions_springs_front_drift.lut']) dataFolder.file('suspensions_springs_front_drift.lut', springLutF);
    if (!S.lutFiles['suspensions_springs_rear_drift.lut']) dataFolder.file('suspensions_springs_rear_drift.lut', springLutR);
    if (!S.lutFiles['suspensions_stabilizer_front_drift.lut']) dataFolder.file('suspensions_stabilizer_front_drift.lut', arbLutF);
    if (!S.lutFiles['suspensions_stabilizer_rear_drift.lut']) dataFolder.file('suspensions_stabilizer_rear_drift.lut', arbLutR);

    // AWD files if drivetrain changed to AWD
    if (S.sel.drivetrain === 'AWD' && S.stock.drivetrain_type !== 'AWD') {
        // Include DCCD lua scripts
        dataFolder.file('script.lua', DCCD_SCRIPT);
        dataFolder.file('script_dccd.lua', DCCD_MODULE);
        dataFolder.file('ctrl_centre_diff.ini', DCCD_CENTRE_INI);
        dataFolder.file('ctrl_front_diff.ini', DCCD_FRONT_INI);
    }

    // README
    const carName = S.stock.screen_name || 'Unknown';
    let readme = `RealiSimHQ Physics Tool ‚Äî Modification Output\n${'‚ïê'.repeat(50)}\n\n`;
    readme += `Car: ${carName}\n`;
    readme += `Generated: ${new Date().toISOString().split('T')[0]}\n\n`;
    readme += `Parts Installed:\n`;
    const sm = r.summary;
    if (sm.coilovers.id !== 'stock') readme += `  Coilovers: ${sm.coilovers.brand} ${sm.coilovers.name}\n`;
    if (sm.angle_kit.id !== 'stock') readme += `  Angle Kit: ${sm.angle_kit.brand} ${sm.angle_kit.name}\n`;
    if (sm.brakes.id !== 'stock') readme += `  Brakes: ${sm.brakes.brand} ${sm.brakes.name}\n`;
    if (sm.diff.id !== 'stock') readme += `  Differential: ${sm.diff.brand} ${sm.diff.name}\n`;
    if (sm.engine.id !== 'stock') readme += `  Engine: ${sm.engine.brand} ${sm.engine.name}\n`;
    if (sm.turbo.id !== 'none') readme += `  Turbo: ${sm.turbo.name} (${sm.turbo.max_boost} bar)\n`;
    readme += `  Tire Compound: ${sm.compound.name}\n`;
    readme += `  Drivetrain: ${sm.drivetrain}\n`;
    readme += `\nPhysics Summary:\n`;
    readme += `  Total Mass: ${sm.total_mass} kg\n`;
    readme += `  Weight Dist: ${(sm.wdf*100).toFixed(1)}% front\n`;
    readme += `  Natural Freq: ${sm.freq_f} / ${sm.freq_r} Hz (F/R)\n`;
    readme += `  Max Steering Angle: ${sm.max_angle}¬∞\n`;
    readme += `  Estimated HP: ~${sm.estimated_hp || '?'}\n`;
    readme += `\n${'‚îÄ'.repeat(50)}\nInstallation Instructions:\n`;
    readme += `  1. BACK UP your original data/ folder first!\n`;
    readme += `  2. Extract the data/ folder from this zip\n`;
    readme += `  3. Copy into: assettocorsa/content/cars/YOUR_CAR/\n`;
    readme += `  4. Choose OVERWRITE when prompted\n`;
    readme += `  5. The modified physics files will replace the originals\n`;
    readme += `\n‚ö†Ô∏è  Always keep a backup of your original files!\n`;
    readme += `\nGenerated by RealiSimHQ Physics Tool v4.0\n`;
    zip.file('README.txt', readme);

    const blob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `RealiSimHQ_${carName.replace(/[^a-zA-Z0-9]/g, '_')}_physics.zip`;
    a.click();
    URL.revokeObjectURL(url);
    toast('üì¶ Download started!');
}

// ‚îÄ‚îÄ AWD / DCCD script content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DCCD_SCRIPT = `-- Main modular script loader
local function safe_require(name)
    local ok, mod = pcall(require, name)
    if not ok then ac.log("Module not found: " .. name) return nil end
    return mod
end
local dccd = safe_require("script_dccd")
function script.update(dt)
    if type(dccd) == "table" and dccd.rundccd then dccd.rundccd(dt) end
end`;

const DCCD_MODULE = `-- script_dccd.lua ‚Äî DCCD controller
if car.isAIControlled then return nil end
local counter = 0
local prev_extraB = car.extraB
local prev_extraC = car.extraC
local dccd_ratio = 0.0
local function updateDCCDLock()
    dccd_ratio = counter / 5.0
    car:setGripExtra(0, dccd_ratio)
end
local function rundccd(dt)
    if car.extraC ~= prev_extraC then
        counter = counter + 1
        prev_extraC = car.extraC
        updateDCCDLock()
    end
    if car.extraB ~= prev_extraB then
        counter = counter - 1
        prev_extraB = car.extraB
        updateDCCDLock()
    end
    counter = math.max(0, math.min(5, counter))
end
return { rundccd = rundccd }`;

const DCCD_CENTRE_INI = `[CONTROLLER_0]\nINPUT=GRIP_EXTRA_0\nLUT=(|0=0|1=13|2=20|3=50|4=80|5=99|)\nFILTER=0.95\nUP_LIMIT=100\nDOWN_LIMIT=0`;
const DCCD_FRONT_INI = `[CONTROLLER_0]\nINPUT=GRIP_EXTRA_0\nLUT=(|0=13|1=13|2=13|3=13|4=19|5=25|)\nFILTER=0.95\nUP_LIMIT=100\nDOWN_LIMIT=0`;

</script>
</body>
</html>